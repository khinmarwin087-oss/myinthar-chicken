<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçó ·Äô·Äº·ÄÑ·Ä∫·Äû·Ä¨·ÄÄ·Äº·ÄÄ·Ä∫·ÄÄ·ÄÑ·Ä∫ POS - Smart System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pyidaungsu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --amazon-orange: #ff9900; --amazon-dark: #232f3e; --bg: #f3f3f3; }
        body { font-family: 'Pyidaungsu', sans-serif; background: var(--bg); margin: 0; padding: 0; color: #111; }
        .app-container { max-width: 500px; margin: auto; background: white; min-height: 100vh; position: relative; }
        
        /* Amazon Style Header */
        header { background: var(--amazon-dark); color: white; padding: 15px; text-align: center; }
        .nav-tabs { display: flex; background: #37475a; position: sticky; top: 0; z-index: 100; }
        .nav-tabs button { flex: 1; padding: 12px; border: none; background: none; color: #ccc; cursor: pointer; font-size: 14px; }
        .nav-tabs button.active { color: white; border-bottom: 4px solid var(--amazon-orange); font-weight: bold; }
        
        .content { padding: 15px; padding-bottom: 150px; }
        .card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }

        /* Item Style */
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .qty-ctrl { display: flex; align-items: center; gap: 10px; }
        .btn-qty { width: 30px; height: 30px; border: 1px solid #bbb; background: #e7e9ec; border-radius: 4px; cursor: pointer; }
        
        /* Payment Section */
        .pay-box { background: #fff9f0; border: 1px solid #ffcc66; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .pay-method { display: flex; gap: 10px; margin-top: 10px; }
        .pay-method label { flex: 1; border: 1px solid #ddd; padding: 10px; text-align: center; border-radius: 5px; cursor: pointer; }
        .pay-method input:checked + label { border-color: var(--amazon-orange); background: #fff5e6; }

        /* Admin/Voucher Style */
        .voucher-box { border: 2px dashed #bbb; padding: 20px; background: #fff; text-align: center; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #eee; }
        
        /* Footer Cart */
        .footer-cart { position: fixed; bottom: 0; max-width: 500px; width: 100%; background: white; border-top: 1px solid #ddd; padding: 20px; box-sizing: border-box; }
        .btn-buy { background: #ffd814; border: 1px solid #fcd200; border-radius: 20px; width: 100%; padding: 12px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        input[type="text"], input[type="tel"], select { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid #bbb; border-radius: 4px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h3 style="margin:0;">MYINTHAR BBQ</h3>
    </header>

    <div class="nav-tabs">
        <button id="tab-buy" class="active" onclick="switchTab('buy')">SHOP</button>
        <button id="tab-orders" onclick="switchTab('orders')">MY ORDERS</button>
        <button id="tab-admin" onclick="switchTab('admin')">ADMIN</button>
    </div>

    <div id="sec-buy" class="content">
        <div class="card">
            <label>üë§ ·Äù·Äö·Ä∫·Äö·Ä∞·Äû·Ä∞·Ä°·Äô·Ää·Ä∫</label>
            <input type="text" id="c_name" placeholder="Name">
            <label>üìû ·Äñ·ÄØ·Äî·Ä∫·Ä∏·Äî·Ä∂·Äï·Ä´·Äê·Ä∫</label>
            <input type="tel" id="c_phone" placeholder="09xxxxxxxxx">
        </div>
        <div id="menu_list"></div>
    </div>

    <div id="sec-checkout" class="content hidden">
        <div class="card" id="voucher_print">
            <h3 style="text-align:center; color:var(--amazon-orange);">VOUCHER</h3>
            <div id="order_summary" style="font-size:14px; margin-bottom:15px;"></div>
            <hr>
            <div class="pay-box">
                <p style="margin:0 0 10px; font-weight:bold;">üí∞ ·ÄÑ·ÄΩ·Ä±·Äï·Ä±·Ä∏·ÄÅ·Äª·Ä±·Äõ·Äî·Ä∫</p>
                <p style="font-size:13px; margin:2px 0;"><b>KPay:</b> 09123456789 (U Ye Win)</p>
                <p style="font-size:13px; margin:2px 0;"><b>AYA Pay:</b> 09123456789 (U Ye Win)</p>
            </div>
            <div class="pay-method">
                <input type="radio" name="pm" id="kp" value="KPay" checked class="hidden">
                <label for="kp">KPay</label>
                <input type="radio" name="pm" id="ap" value="AYA Pay" class="hidden">
                <label for="ap">AYA Pay</label>
            </div>
            <label style="display:block; margin-top:15px; font-size:13px;">·ÄÑ·ÄΩ·Ä±·Äú·ÄΩ·Äæ·Ä≤·Äñ·Äº·Äê·Ä∫·Äï·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏ ·Äê·ÄÑ·Ä∫·Äï·Ä´</label>
            <input type="file" id="p_img" accept="image/*">
            <input type="text" id="p_txid" placeholder="Transaction ID (·Äî·Ä±·Ä¨·ÄÄ·Ä∫·ÄÜ·ÄØ·Ä∂·Ä∏ ·ÅÜ ·Äú·ÄØ·Ä∂·Ä∏)">
        </div>
        <button class="btn-buy" onclick="submitOrder()">·Ä°·Ä±·Ä¨·Ä∫·Äí·Ä´·Ä°·Äê·Ää·Ä∫·Äï·Äº·ÄØ·Äô·Ää·Ä∫</button>
        <button onclick="switchTab('buy')" style="width:100%; background:none; border:none; margin-top:10px; color:gray;">Back to Shop</button>
    </div>

    <div id="sec-admin" class="content hidden">
        <div id="admin_auth">
            <input type="password" id="admin_pass" placeholder="Admin Password">
            <button class="btn-buy" onclick="adminLogin()">Login</button>
        </div>
        <div id="admin_dashboard" class="hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <div class="card" style="flex:1; text-align:center; margin-right:5px;"><b>·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äõ·ÄÑ·ÄΩ·Ä±</b><br><span id="total_sales">0</span> K</div>
                <div class="card" style="flex:1; text-align:center;"><b>·Ä°·Ä±·Ä¨·Ä∫·Äí·Ä´</b><br><span id="order_count">0</span></div>
            </div>
            <h4>·Ä°·Ä±·Ä¨·Ä∫·Äí·Ä´·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Ä°·Äû·Ä±·Ä∏·ÄÖ·Ä≠·Äê·Ä∫</h4>
            <div id="admin_order_list"></div>
        </div>
    </div>

    <div id="cart_footer" class="footer-cart">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <span style="font-weight:bold;">Total:</span>
            <span style="color:var(--amazon-orange); font-weight:bold;"><span id="total_price">0</span> MMK</span>
        </div>
        <button class="btn-buy" onclick="goToCheckOut()">·Ä°·Ä±·Ä¨·Ä∫·Äí·Ä´·Äê·ÄÑ·Ä∫·Äõ·Äî·Ä∫ ·ÄÜ·ÄÄ·Ä∫·Äû·ÄΩ·Ä¨·Ä∏·Äô·Ää·Ä∫</button>
    </div>
</div>

<script>
    const SB_URL = "https://ltusknkpwbyriikeyday.supabase.co";
    const SB_KEY = "sb_publishable_u9Y8SIpzqsT4WkyONV4J2w__Xwc09Fv";
    const _supabase = window.supabase.createClient(SB_URL, SB_KEY);

    const TG_TOKEN = "8215695761:AAF1qDjAJn7gjiHyzf8t7W6c8e51cim98sU";
    const TG_CHAT_ID = "8116152317";

    let menu = [];
    let cart = {};

    async function init() {
        const { data } = await _supabase.from('inventory').select('*').order('id', { ascending: true });
        menu = data;
        renderMenu();
    }

    function renderMenu() {
        document.getElementById('menu_list').innerHTML = menu.map(item => `
            <div class="item-row ${item.is_available ? '' : 'hidden'}">
                <span><b>${item.item_name}</b><br><small>${item.price} K</small></span>
                <div class="qty-ctrl">
                    <button class="btn-qty" onclick="updateQty('${item.item_name}', -1)">-</button>
                    <span id="q_${item.item_name}">0</span>
                    <button class="btn-qty" onclick="updateQty('${item.item_name}', 1)">+</button>
                </div>
            </div>
        `).join('');
    }

    function updateQty(name, change) {
        cart[name] = (cart[name] || 0) + change;
        if (cart[name] < 0) cart[name] = 0;
        document.getElementById(`q_${name}`).innerText = cart[name];
        let total = 0;
        for (let k in cart) total += (cart[k] * menu.find(i => i.item_name === k).price);
        document.getElementById('total_price').innerText = total.toLocaleString();
    }

    function switchTab(tab) {
        document.querySelectorAll('.content').forEach(s => s.classList.add('hidden'));
        document.querySelectorAll('.nav-tabs button').forEach(b => b.classList.remove('active'));
        document.getElementById('sec-' + tab).classList.remove('hidden');
        document.getElementById('tab-' + tab)?.classList.add('active');
        document.getElementById('cart_footer').classList.toggle('hidden', tab !== 'buy');
    }

    function goToCheckOut() {
        const name = document.getElementById('c_name').value;
        if (!name || document.getElementById('total_price').innerText == "0") return alert("·Ä°·Äô·Ää·Ä∫·Äî·Äæ·ÄÑ·Ä∑·Ä∫ ·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏ ·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä±·Ä∏·Äï·Ä´·Åã");
        
        let summary = `<p><b>Name:</b> ${name}</p><p><b>Items:</b></p><ul>`;
        for (let k in cart) if (cart[k] > 0) summary += `<li>${k} x ${cart[k]}</li>`;
        summary += `</ul><p><b>Total:</b> ${document.getElementById('total_price').innerText} MMK</p>`;
        
        document.getElementById('order_summary').innerHTML = summary;
        switchTab('checkout');
        document.getElementById('cart_footer').classList.add('hidden');
    }

    async function submitOrder() {
        const btn = document.querySelector('.btn-buy');
        btn.disabled = true; btn.innerText = "Please wait...";

        const file = document.getElementById('p_img').files[0];
        let imgUrl = "";
        if (file) {
            const fName = Date.now() + "_" + file.name;
            const { data } = await _supabase.storage.from('payment-proofs').upload(fName, file);
            if (data) imgUrl = SB_URL + "/storage/v1/object/public/payment-proofs/" + fName;
        }

        const orderData = {
            customer_name: document.getElementById('c_name').value,
            phone: document.getElementById('c_phone').value,
            items: Object.keys(cart).filter(k => cart[k] > 0).map(k => `${k}(${cart[k]})`).join(", "),
            total: parseInt(document.getElementById('total_price').innerText.replace(/,/g, '')),
            payment_method: document.querySelector('input[name="pm"]:checked').value,
            transaction_id: document.getElementById('p_txid').value,
            payment_image: imgUrl
        };

        const { data: res, error } = await _supabase.from('orders').insert([orderData]).select();

        if (!error) {
            const msg = `üîî *·Ä°·Ä±·Ä¨·Ä∫·Äí·Ä´·Ä°·Äû·ÄÖ·Ä∫*%0AID: #${res[0].id}%0Aüë§ Customer: ${orderData.customer_name}%0Aüìû Phone: ${orderData.phone}%0Aüì¶ *·Äô·Äæ·Ä¨·Äö·Ä∞·Äû·Ää·Ä∑·Ä∫·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏:* ${orderData.items}%0Aüí∞ ·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏: ${orderData.total} K%0Aüí≥ Pay: ${orderData.payment_method}%0Aüîë TXID: ${orderData.transaction_id}`;
            fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage?chat_id=${TG_CHAT_ID}&text=${msg}&parse_mode=Markdown`);
            alert("Order Submitted! Please save your voucher.");
            location.reload();
        }
    }

    // Admin Dashboard Logic
    async function adminLogin() {
        if (document.getElementById('admin_pass').value === "2012@Yewin") {
            document.getElementById('admin_auth').classList.add('hidden');
            document.getElementById('admin_dashboard').classList.remove('hidden');
            const { data: ords } = await _supabase.from('orders').select('*').order('id', { descending: true });
            const total = ords.reduce((a, b) => a + b.total, 0);
            document.getElementById('total_sales').innerText = total.toLocaleString();
            document.getElementById('order_count').innerText = ords.length;
            
            document.getElementById('admin_order_list').innerHTML = ords.map(o => `
                <div class="card" style="font-size:13px;">
                    <b>#${o.id} - ${o.customer_name}</b> (${o.phone})<br>
                    <span style="color:#d35400;">${o.items}</span><br>
                    <b>${o.total} K</b> | ${o.payment_method} | ID: ${o.transaction_id || 'No ID'}<br>
                    ${o.payment_image ? `<a href="${o.payment_image}" target="_blank">View Screenshot</a>` : 'No Image'}
                </div>
            `).join('');
        }
    }

    window.onload = init;
</script>
</body>
</html>


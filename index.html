<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ— á€™á€¼á€„á€ºá€á€¬á€€á€¼á€€á€ºá€€á€„á€º - Home</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pyidaungsu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e67e22; --secondary: #d35400; --bg: #fdfdfd; }
        body { font-family: 'Pyidaungsu', sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; }
        .hero { background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1598515214211-89d3c73ae83b?auto=format&fit=crop&w=800&q=80'); 
                height: 180px; background-size: cover; background-position: center;
                display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; border-radius: 0 0 30px 30px; }
        .container { max-width: 600px; margin: auto; padding: 15px; }
        .category-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; scrollbar-width: none; }
        .chip { background: #eee; padding: 8px 18px; border-radius: 20px; font-size: 14px; white-space: nowrap; cursor: pointer; transition: 0.3s; }
        .chip.active { background: var(--primary); color: white; }
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .card img { width: 100%; height: 110px; object-fit: cover; }
        .card-info { padding: 10px; flex-grow: 1; }
        .price { color: var(--secondary); font-weight: bold; font-size: 15px; }
        .qty-ctrl { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; background: #f8f9fa; padding: 5px; border-radius: 8px; }
        .btn-q { width: 28px; height: 28px; border: none; border-radius: 5px; background: white; cursor: pointer; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .footer { position: fixed; bottom: 0; width: 100%; max-width: 600px; left: 50%; transform: translateX(-50%); background: white; padding: 15px; 
                  display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); z-index: 999; }
        .btn-main { background: var(--secondary); color: white; border: none; padding: 12px 25px; border-radius: 12px; font-weight: bold; cursor: pointer; }
        #user-profile { padding: 10px 15px; display: flex; align-items: center; gap: 10px; background: #fff; border-bottom: 1px solid #eee; font-size: 14px; }
    </style>
</head>
<body>

<div id="user-profile">á€…á€…á€ºá€†á€±á€¸á€”á€±á€á€Šá€º...</div>

<div class="hero">
    <h1 style="margin:0;">ğŸ— á€™á€¼á€„á€ºá€á€¬á€€á€¼á€€á€ºá€€á€„á€º</h1>
    <p style="margin:5px 0 0 0; opacity: 0.9;">á€›á€á€¬á€…á€¯á€¶á€œá€„á€º á€¡á€€á€„á€ºá€…á€¯á€¶</p>
</div>

<div class="container">
    <div class="category-scroll">
        <div class="chip active" onclick="filterMenu('á€¡á€¬á€¸á€œá€¯á€¶á€¸', this)">á€¡á€¬á€¸á€œá€¯á€¶á€¸</div>
        <div class="chip" onclick="filterMenu('á€¡á€á€¬á€¸á€€á€„á€º', this)">á€¡á€á€¬á€¸á€€á€„á€º</div>
        <div class="chip" onclick="filterMenu('á€€á€œá€®á€…á€¬', this)">á€€á€œá€®á€…á€¬</div>
        <div class="chip" onclick="filterMenu('á€¡á€á€®á€¸á€¡á€›á€½á€€á€º', this)">á€¡á€á€®á€¸á€¡á€›á€½á€€á€º</div>
    </div>

    <div id="menu-display" class="menu-grid">á€™á€®á€”á€°á€¸á€™á€»á€¬á€¸ á€†á€½á€²á€šá€°á€”á€±á€á€Šá€º...</div>
</div>

<div class="footer">
    <div>á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸: <b style="font-size: 1.2rem; color: var(--secondary);"><span id="total-price">0</span> K</b></div>
    <button class="btn-main" onclick="goToCheckout()">á€™á€¾á€¬á€šá€°á€™á€Šá€º â”</button>
</div>

<div id="chat-container" style="position: fixed; bottom: 90px; right: 20px; z-index: 1000;">
    <button onclick="toggleChat()" style="background: #7360f2; color: white; border: none; width: 55px; height: 55px; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 24px; cursor: pointer;">ğŸ’¬</button>
    <div id="chat-window" style="display: none; position: absolute; bottom: 65px; right: 0; width: 280px; height: 380px; background: white; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); flex-direction: column; overflow: hidden; border: 1px solid #eee;">
        <div style="background: #7360f2; color: white; padding: 12px; font-weight: bold; display: flex; justify-content: space-between;">
            <span>Customer Chat</span>
            <span onclick="toggleChat()" style="cursor:pointer;">âœ–</span>
        </div>
        <div id="chat-messages" style="flex: 1; padding: 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; font-size: 13px; background: #f9f9f9;"></div>
        <div style="padding: 8px; border-top: 1px solid #eee; display: flex; background: white;">
            <input type="text" id="chat-input" placeholder="á€…á€¬á€›á€±á€¸á€›á€”á€º..." style="flex: 1; border: 1px solid #ddd; padding: 8px; border-radius: 5px; outline: none;">
            <button onclick="sendMessage()" style="background: #7360f2; color: white; border: none; padding: 8px 12px; margin-left: 5px; border-radius: 5px; cursor: pointer;">Send</button>
        </div>
    </div>
</div>

<script>
    const SB_URL = "https://ltusknkpwbyriikeyday.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0dXNrbmtwd2J5cmlpa2V5ZGF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMTYxNDksImV4cCI6MjA4MTc5MjE0OX0.7TXAvr2tHl03m_gYZNYq8xyy0yYHTx0sYMN4tS6GDnA";
const _supabase = window.supabase.createClient(SB_URL, SB_KEY);


    let allMenuItems = [];
    let cart = {};

    // áá‹ User Profile á€…á€…á€ºá€†á€±á€¸á€á€¼á€„á€ºá€¸
    async function checkUser() {
        const { data: { user } } = await _supabase.auth.getUser();
        const profileDiv = document.getElementById('user-profile');
        if (user) {
            profileDiv.innerHTML = `
                <img src="${user.user_metadata.avatar_url || 'https://via.placeholder.com/35'}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;">
                <span><b>${user.user_metadata.full_name || user.email}</b></span>
                <button onclick="logout()" style="margin-left:auto; border:none; background:none; color:#e74c3c; cursor:pointer;">á€‘á€½á€€á€ºá€›á€”á€º</button>`;
        } else {
            profileDiv.innerHTML = `á€§á€Šá€·á€ºá€á€Šá€ºá€¡á€–á€¼á€…á€º á€€á€¼á€Šá€·á€ºá€›á€¾á€¯á€”á€±á€á€Šá€º <a href="auth.html" style="margin-left:auto; color:var(--primary); font-weight:bold; text-decoration:none;">Login á€á€„á€ºá€›á€”á€º</a>`;
        }
    }

    async function logout() {
        await _supabase.auth.signOut();
        location.reload();
    }

    // á‚á‹ á€™á€®á€”á€°á€¸á€™á€»á€¬á€¸ á€†á€½á€²á€šá€°á€á€¼á€„á€ºá€¸
    async function loadMenu() {
        const { data, error } = await _supabase.from('menu_items').select('*').order('id');
        if (error) return console.error(error);
        allMenuItems = data;
        renderMenu(allMenuItems);
    }

    function renderMenu(items) {
        const display = document.getElementById('menu-display');
        display.innerHTML = items.map(item => `
            <div class="card">
                <img src="${item.image_url}" alt="${item.name}">
                <div class="card-info">
                    <div style="font-weight:bold; font-size:14px;">${item.name}</div>
                    <div class="price">${item.price.toLocaleString()} K</div>
                    <div class="qty-ctrl">
                        <button class="btn-q" onclick="updateQty('${item.name}', -1, ${item.price})">-</button>
                        <span id="q-${item.name}" style="font-weight:bold;">${cart[item.name] || 0}</span>
                        <button class="btn-q" onclick="updateQty('${item.name}', 1, ${item.price})">+</button>
                    </div>
                </div>
            </div>`).join('');
    }

    // áƒá‹ Category á€á€½á€²á€á€¼á€„á€ºá€¸
    function filterMenu(cat, el) {
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        if (cat === 'á€¡á€¬á€¸á€œá€¯á€¶á€¸') renderMenu(allMenuItems);
        else renderMenu(allMenuItems.filter(i => i.category === cat));
    }

    // á„á‹ á€¡á€›á€±á€¡á€á€½á€€á€ºá€”á€¾á€„á€·á€º á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸á€á€½á€€á€ºá€á€¼á€„á€ºá€¸
    function updateQty(name, change, price) {
        if (!cart[name]) cart[name] = 0;
        cart[name] += change;
        if (cart[name] < 0) cart[name] = 0;
        
        document.getElementById(`q-${name}`).innerText = cart[name];
        calculateTotal();
    }

    function calculateTotal() {
        let total = 0;
        for (let name in cart) {
            const item = allMenuItems.find(i => i.name === name);
            if (item) total += cart[name] * item.price;
        }
        document.getElementById('total-price').innerText = total.toLocaleString();
    }

    // á…á‹ Chat Logic
    function toggleChat() {
        const win = document.getElementById('chat-window');
        win.style.display = (win.style.display === 'none' || win.style.display === '') ? 'flex' : 'none';
        if(win.style.display === 'flex') loadMessages();
    }

    async function sendMessage() {
        const input = document.getElementById('chat-input');
        if (!input.value) return;
        const { data: { user } } = await _supabase.auth.getUser();
        if (!user) return alert("á€…á€¬á€•á€­á€¯á€·á€›á€”á€º Login á€¡á€›á€„á€ºá€á€„á€ºá€•á€±á€¸á€•á€«á‹");

        await _supabase.from('chat_messages').insert([{
            user_id: user.id,
            user_name: user.user_metadata.full_name || "Customer",
            message: input.value
        }]);
        input.value = '';
        loadMessages();
    }

    async function loadMessages() {
        const { data: { user } } = await _supabase.auth.getUser();
        if (!user) return;
        const { data } = await _supabase.from('chat_messages').select('*').eq('user_id', user.id).order('created_at', { ascending: true });
        const box = document.getElementById('chat-messages');
        box.innerHTML = data.map(m => `
            <div style="align-self: ${m.is_admin_reply ? 'flex-start' : 'flex-end'}; 
                        background: ${m.is_admin_reply ? '#eee' : '#7360f2'}; 
                        color: ${m.is_admin_reply ? '#333' : 'white'}; 
                        padding: 8px 12px; border-radius: 12px; max-width: 85%;">
                ${m.message}
            </div>`).join('');
        box.scrollTop = box.scrollHeight;
    }

    function goToCheckout() {
        if (document.getElementById('total-price').innerText === "0") return alert("á€•á€…á€¹á€…á€Šá€ºá€¸ á€¡á€›á€„á€ºá€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«á‹");
        alert("á€™á€¾á€¬á€šá€°á€™á€¾á€¯ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«á€á€Šá€ºá‹ (Checkout Page á€á€­á€¯á€· á€†á€€á€ºá€á€½á€¬á€¸á€›á€”á€º á€á€»á€­á€á€ºá€†á€€á€ºá€”á€­á€¯á€„á€ºá€á€Šá€º)");
    }

    window.onload = () => { checkUser(); loadMenu(); };
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="my">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>K.M.W Pro Wholesale</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:sans-serif;background:#f5f7f9}
.top{background:#fff;padding:15px;font-weight:800;color:#ff4747;
display:flex;justify-content:space-between;position:sticky;top:0}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px}
.card{background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 4px 10px #0001}
.card img{width:100%;height:150px;object-fit:cover}
.card div{padding:10px}
.drawer{position:fixed;bottom:-100%;left:0;width:100%;background:#fff;
border-radius:25px 25px 0 0;transition:.4s;max-height:90vh;overflow:auto;padding:20px}
.drawer.active{bottom:0}
.overlay{position:fixed;inset:0;background:#0007;display:none}
.btn{width:100%;padding:14px;border:none;border-radius:14px;
background:#ff4747;color:#fff;font-weight:800;margin-top:10px}
.qty{display:flex;align-items:center;gap:10px;margin:10px 0}
.qty button{padding:6px 12px}
.bottom{position:fixed;bottom:0;width:100%;background:#fff;
display:flex;justify-content:space-around;padding:10px}
</style>
</head>

<body>

<div class="overlay" id="overlay" onclick="closeAll()"></div>

<div class="top">
  <div>K.M.W Wholesale</div>
  <div onclick="openCart()">üõí <span id="cartCount">0</span></div>
</div>

<div id="products" class="grid">Loading‚Ä¶</div>

<!-- PRODUCT -->
<div class="drawer" id="productDrawer">
  <div id="productDetail"></div>
</div>

<!-- CART -->
<div class="drawer" id="cartDrawer">
  <h3>üõí Bulk Order</h3>
  <div id="cartList"></div>
  <b id="cartTotal">0 K</b>
  <button class="btn" onclick="submitOrder()">·Ä°·Ä±·Ä¨·Ä∫·Äí·Ä´·Äê·ÄÑ·Ä∫·Äô·Ää·Ä∫</button>
</div>

<div class="bottom">
  <div onclick="closeAll()">üè† Home</div>
  <div onclick="openCart()">üõí Cart</div>
</div>

<script>
const SB_URL = "https://ltusknkpwbyriikeyday.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0dXNrbmtwd2J5cmlpa2V5ZGF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMTYxNDksImV4cCI6MjA4MTc5MjE0OX0.7TXAvr2tHl03m_gYZNYq8xyy0yYHTx0sYMN4tS6GDnA";
    const _supabase = window.supabase.createClient(SB_URL, SB_KEY);

let products=[], cart=[], current=null, qty=10;

async function load(){
  const {data}=await sb.from("menu_items").select("*");
  products=data||[];
  render();
}
load();

function render(){
  document.getElementById("products").innerHTML =
  products.map(p=>`
    <div class="card" onclick="openProduct(${p.id})">
      <img src="${p.image_url}">
      <div>
        <b>${p.name}</b><br>
        <span>${p.price} K</span>
      </div>
    </div>`).join("");
}

function openProduct(id){
  current=products.find(p=>p.id===id);
  qty=current.moq||10;
  showDrawer("productDrawer");
  updateProduct();
}

function priceByQty(){
  if(qty>=50 && current.wholesale_50) return current.wholesale_50;
  if(qty>=10 && current.wholesale_10) return current.wholesale_10;
  return current.price;
}

function updateProduct(){
  document.getElementById("productDetail").innerHTML=`
  <h2>${current.name}</h2>
  <b>${priceByQty()} K</b>
  <p>MOQ: ${current.moq||10}</p>

  <div class="qty">
    <button onclick="qty--;updateProduct()">-</button>
    <b>${qty}</b>
    <button onclick="qty++;updateProduct()">+</button>
  </div>

  <button class="btn" onclick="addCart()">Add Bulk</button>`;
}

function addCart(){
  if(qty < (current.moq||10)) return alert("MOQ ·Äô·Äï·Äº·Ää·Ä∑·Ä∫·Äï·Ä´");
  cart.push({name:current.name, qty, price:priceByQty()});
  document.getElementById("cartCount").innerText=cart.length;
  closeAll();
}

function openCart(){
  if(!cart.length) return alert("Cart empty");
  showDrawer("cartDrawer");
  document.getElementById("cartList").innerHTML=
  cart.map(i=>`<div>${i.name} x ${i.qty} = ${i.price*i.qty} K</div>`).join("");
  document.getElementById("cartTotal").innerText =
  cart.reduce((s,i)=>s+i.price*i.qty,0)+" K";
}

async function submitOrder(){
  await sb.from("orders").insert([{
    items:cart,
    total_price:cart.reduce((s,i)=>s+i.price*i.qty,0),
    status:"pending"
  }]);
  alert("Order success");
  location.reload();
}

function showDrawer(id){
  document.getElementById("overlay").style.display="block";
  document.getElementById(id).classList.add("active");
}
function closeAll(){
  document.getElementById("overlay").style.display="none";
  document.querySelectorAll(".drawer").forEach(d=>d.classList.remove("active"));
}
</script>

</body>
</html>

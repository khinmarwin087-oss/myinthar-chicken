<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçó MYINTHAR BBQ - LIVE ADMIN</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pyidaungsu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --p-dark: #0f172a; --p-blue: #1e293b; --gold: #fbbf24; --text: #f8fafc; --danger: #ef4444; --success: #22c55e; }
        body { font-family: 'Pyidaungsu', sans-serif; background: var(--p-dark); margin: 0; color: var(--text); overflow-x: hidden; }
        .container { max-width: 500px; margin: auto; background: var(--p-blue); min-height: 100vh; position: relative; }
        header { background: #0f172a; padding: 20px; text-align: center; border-bottom: 2px solid var(--gold); }
        .nav-tabs { display: flex; background: #334155; position: sticky; top: 0; z-index: 100; }
        .nav-tabs button { flex: 1; padding: 15px; border: none; background: none; color: #94a3b8; cursor: pointer; font-weight: bold; }
        .nav-tabs button.active { color: var(--gold); border-bottom: 3px solid var(--gold); background: rgba(251, 191, 36, 0.1); }
        .content { padding: 15px; padding-bottom: 120px; }
        .hidden { display: none !important; }
        .card { background: #1e293b; border: 1px solid #475569; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #334155; }
        .btn-qty { width: 35px; height: 35px; border: none; background: #475569; color: white; border-radius: 8px; font-size: 18px; cursor: pointer; }
        .btn-main { background: var(--gold); color: black; border: none; border-radius: 10px; width: 100%; padding: 15px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-main:active { transform: scale(0.95); }
        input { width: 100%; padding: 12px; margin: 8px 0; background: #0f172a; border: 1px solid #475569; border-radius: 8px; color: white; box-sizing: border-box; }
        .footer-cart { position: fixed; bottom: 0; max-width: 500px; width: 100%; background: #0f172a; padding: 15px; box-sizing: border-box; border-top: 1px solid #475569; }
        
        /* Admin Specific */
        .order-card { border-left: 5px solid var(--gold); background: #334155; padding: 12px; border-radius: 8px; margin-bottom: 10px; position: relative; }
        .status-badge { font-size: 10px; padding: 3px 8px; border-radius: 4px; float: right; }
        .pending { background: #f59e0b; color: black; }
        .done { background: var(--success); color: white; }
        .btn-approve { background: var(--success); color: white; border: none; padding: 8px 15px; border-radius: 5px; margin-top: 10px; width: 100%; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <header><b style="font-size: 20px; color: var(--gold);">MYINTHAR BBQ LIVE</b></header>
    
    <div class="nav-tabs">
        <button id="t-shop" class="active" onclick="showTab('shop')">Menu</button>
        <button id="t-orders" onclick="showTab('orders')">History</button>
        <button id="t-admin" onclick="showTab('admin')">Admin (LIVE)</button>
    </div>

    <div id="sec-shop" class="content">
        <div class="card"><input type="text" id="c_name" placeholder="üë§ ·Äù·Äö·Ä∫·Äû·Ä∞·Ä°·Äô·Ää·Ä∫"><input type="tel" id="c_phone" placeholder="üìû ·Äñ·ÄØ·Äî·Ä∫·Ä∏·Äî·Ä∂·Äï·Ä´·Äê·Ä∫"><input type="text" id="c_time" placeholder="üïí ·Äú·Ä¨·Äö·Ä∞·Äô·Ää·Ä∑·Ä∫·Ä°·ÄÅ·Äª·Ä≠·Äî·Ä∫"></div>
        <div id="menu-list"></div>
    </div>

    <div id="sec-orders" class="content hidden">
        <input type="tel" id="search-phone" placeholder="·Äñ·ÄØ·Äî·Ä∫·Ä∏·Äî·Ä∂·Äï·Ä´·Äê·Ä∫·Äñ·Äº·ÄÑ·Ä∑·Ä∫ ·Äõ·Äæ·Ä¨·Äï·Ä´" oninput="fetchHistory()">
        <div id="history-list"></div>
    </div>

    <div id="sec-admin" class="content hidden">
        <div id="admin-login-box">
            <input type="password" id="adm-pass" placeholder="Admin Password">
            <button class="btn-main" onclick="checkAdmin()">Login</button>
        </div>
        <div id="admin-panel" class="hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                <h3 style="margin:0;">·Äö·Äî·Ä±·Ä∑ ·Ä°·Ä±·Ä¨·Ä∫·Äí·Ä´·Äô·Äª·Ä¨·Ä∏</h3>
                <span id="live-indicator" style="color:var(--success); font-size:12px;">‚óè Live Connected</span>
            </div>
            <div id="adm-orders-list"></div>
        </div>
    </div>

    <div id="footer-cart" class="footer-cart">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><b>·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏:</b> <span id="total-val" style="color:var(--gold); font-size:18px;">0 K</span></div>
        <button class="btn-main" onclick="placeOrder()">·Ä°·Ä±·Ä¨·Ä∫·Äí·Ä´·Äê·ÄÑ·Ä∫·Äô·Ää·Ä∫</button>
    </div>
</div>

<script>
    const SB_URL = "https://ltusknkpwbyriikeyday.supabase.co";
    const SB_KEY = "sb_publishable_u9Y8SIpzqsT4WkyONV4J2w__Xwc09Fv";
    const _supabase = window.supabase.createClient(SB_URL, SB_KEY);
    const TG_TOKEN = "8215695761:AAF1qDjAJn7gjiHyzf8t7W6c8e51cim98sU";
    const TG_CHAT_ID = "8116152317";
    const alarm = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

    let menu = []; let cart = {};

    async function init() {
        const { data } = await _supabase.from('products').select('*').order('id');
        menu = data;
        renderShop();
        
        // üîî REAL-TIME LIVE LISTENER
        _supabase.channel('orders_realtime')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'orders' }, payload => {
                alarm.play().catch(() => {});
                if(!document.getElementById('admin-panel').classList.contains('hidden')) loadAdminOrders();
            })
            .subscribe();
    }

    function showTab(t) {
        document.querySelectorAll('.content').forEach(c => c.classList.add('hidden'));
        document.querySelectorAll('.nav-tabs button').forEach(b => b.classList.remove('active'));
        document.getElementById('sec-'+t).classList.remove('hidden');
        document.getElementById('t-'+t).classList.add('active');
        document.getElementById('footer-cart').classList.toggle('hidden', t !== 'shop');
    }

    function renderShop() {
        document.getElementById('menu-list').innerHTML = menu.map(p => `
            <div class="item-row">
                <div><b>${p.name}</b><br><small style="color:var(--gold)">${p.price} K</small></div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button class="btn-qty" onclick="updateQty('${p.name}', -1)">-</button>
                    <b id="q-${p.name}">0</b>
                    <button class="btn-qty" onclick="updateQty('${p.name}', 1)">+</button>
                </div>
            </div>
        `).join('');
    }

    function updateQty(n, v) {
        cart[n] = (cart[n] || 0) + v; if(cart[n] < 0) cart[n] = 0;
        document.getElementById('q-'+n).innerText = cart[n];
        let total = 0; menu.forEach(m => total += (cart[m.name] || 0) * m.price);
        document.getElementById('total-val').innerText = total.toLocaleString() + " K";
    }

    async function placeOrder() {
        const name = document.getElementById('c_name').value;
        const phone = document.getElementById('c_phone').value;
        const time = document.getElementById('c_time').value;
        const total = document.getElementById('total-val').innerText;
        if(!name || total === "0 K") return alert("·Ä°·Äô·Ää·Ä∫·Äî·Äæ·ÄÑ·Ä∑·Ä∫ ·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä´·Åã");

        let itemsArr = []; let tgItems = "";
        for(let k in cart) {
            if(cart[k] > 0) {
                itemsArr.push(`${k}(${cart[k]})`);
                tgItems += `üî∏ ${k}: ${cart[k]} ·ÄÅ·ÄØ%0A`;
            }
        }

        const { data, error } = await _supabase.from('orders').insert([{
            customer_name: name, phone: phone, pickup_time: time, items: itemsArr.join(", "), total: parseInt(total.replace(/,/g,''))
        }]).select();

        if(!error) {
            const orderMsg = `üßæ *·Äô·Äº·ÄÑ·Ä∫·Äû·Ä¨·ÄÄ·Äº·ÄÄ·Ä∫·ÄÄ·ÄÑ·Ä∫ - ·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ·Äú·ÄΩ·Äæ·Ä¨*%0AüÜî ·Ä°·Ä±·Ä¨·Ä∫·Äí·Ä´: MT-${1000 + data[0].id}%0Aüë§ ·Ä°·Äô·Ää·Ä∫: ${name}%0Aüìû ·Äñ·ÄØ·Äî·Ä∫·Ä∏: ${phone}%0Aüïí ·Ä°·ÄÅ·Äª·Ä≠·Äî·Ä∫: ${time}%0A--------------------------------%0Aüõí ·Äô·Äæ·Ä¨·Äö·Ä∞·Äû·Ää·Ä∑·Ä∫·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏:%0A${tgItems}üí∞ *·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏: ${total} MMK*`;
            fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage?chat_id=${TG_CHAT_ID}&text=${orderMsg}&parse_mode=Markdown`);
            alert("·Ä°·Ä±·Ä¨·Ä∫·Äí·Ä´·Äê·ÄÑ·Ä∫·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ·Åã"); location.reload();
        }
    }

    function checkAdmin() {
        if(document.getElementById('adm-pass').value === "2012@Yewin") {
            document.getElementById('admin-login-box').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            loadAdminOrders();
        }
    }

    async function loadAdminOrders() {
        const { data } = await _supabase.from('orders').select('*').order('id', {descending: true}).limit(20);
        document.getElementById('adm-orders-list').innerHTML = data.map(o => `
            <div class="order-card">
                <span class="status-badge ${o.status === '·Ä°·Äê·Ää·Ä∫·Äï·Äº·ÄØ·Äï·Äº·ÄÆ·Ä∏' ? 'done' : 'pending'}">${o.status}</span>
                <b>MT-${1000 + o.id} - ${o.customer_name}</b><br>
                <small>${o.items}</small><br>
                <div style="margin-top:5px; font-weight:bold; color:var(--gold);">${o.total.toLocaleString()} K | üïí ${o.pickup_time || '-'}</div>
                ${o.status !== '·Ä°·Äê·Ää·Ä∫·Äï·Äº·ÄØ·Äï·Äº·ÄÆ·Ä∏' ? `<button class="btn-approve" onclick="confirmOrder(${o.id})">·Ä°·Äê·Ää·Ä∫·Äï·Äº·ÄØ·Äô·Ää·Ä∫</button>` : ''}
            </div>
        `).join('');
    }

    async function confirmOrder(id) {
        const { error } = await _supabase.from('orders').update({ status: '·Ä°·Äê·Ää·Ä∫·Äï·Äº·ÄØ·Äï·Äº·ÄÆ·Ä∏' }).eq('id', id);
        if(!error) loadAdminOrders();
    }

    async function fetchHistory() {
        const p = document.getElementById('search-phone').value; if(p.length < 7) return;
        const { data } = await _supabase.from('orders').select('*').eq('phone', p).order('id', {descending:true});
        document.getElementById('history-list').innerHTML = data.map(o => `<div class="card"><b>MT-${1000+o.id}</b> [${o.status}]<br><small>${o.items}</small><br><b>${o.total.toLocaleString()} K</b></div>`).join('');
    }

    window.onload = init;
</script>
</body>
</html>

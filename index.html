<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.M.W Premium Wholesale</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #FF4747; --dark: #1e1e2d; --bg: #f8f9fa; --white: #ffffff; }
        body { margin:0; font-family: 'Segoe UI', sans-serif; background:var(--bg); color:var(--dark); }

        /* Page Logic */
        .page { display: none; padding-bottom: 90px; min-height: 100vh; animation: slideIn 0.3s ease-out; }
        .page.active { display: block; }
        @keyframes slideIn { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Elegant Back Button & Header */
        .glass-header { background: rgba(255, 71, 71, 0.95); backdrop-filter: blur(10px); color: white; padding: 15px; display: flex; align-items: center; position: sticky; top: 0; z-index: 1000; gap: 15px; }
        .back-btn { width: 35px; height: 35px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; }
        .back-btn:hover { background: rgba(255,255,255,0.4); }

        /* Product Detail & Quantity UI */
        .detail-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; }
        .qty-container { display: flex; align-items: center; gap: 20px; margin: 20px 0; padding: 15px; background: #fff; border-radius: 12px; }
        .qty-btn { width: 35px; height: 35px; border: 1.5px solid #ddd; background: white; border-radius: 8px; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        /* Premium Form UI */
        .premium-input { width: 100%; padding: 15px; margin-bottom: 15px; border: 1.5px solid #eee; border-radius: 12px; font-size: 16px; box-sizing: border-box; outline: none; transition: 0.3s; }
        .premium-input:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(255,71,71,0.1); }

        /* Sound Notification Popup */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--dark); color: white; padding: 10px 20px; border-radius: 20px; display: none; z-index: 3000; }

        /* Invoice Style */
        #invoice-area { padding: 25px; background: #fff; border: 1px solid #eee; border-radius: 15px; width: 100%; box-sizing: border-box; }
        .invoice-title { text-align: center; color: var(--primary); border-bottom: 2px dashed #eee; padding-bottom: 15px; }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #eee; z-index: 2000; }
        .nav-item { text-align: center; color: #bbb; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-item i { font-size: 22px; display: block; margin-bottom: 4px; }
        
        .btn-main { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 30px; width: 100%; font-weight: bold; font-size: 16px; cursor: pointer; box-shadow: 0 5px 15px rgba(255,71,71,0.3); }
    </style>
</head>
<body>

<div id="home" class="page active">
    <header class="glass-header">
        <div style="font-weight:bold; font-size:1.4rem;">KMW</div>
        <div style="flex:1; background:white; border-radius:20px; padding:6px 15px; display:flex; align-items:center;">
            <i class="fas fa-search" style="color:#ccc"></i>
            <input type="text" placeholder="Search..." style="border:none; outline:none; margin-left:10px; width:100%;">
        </div>
    </header>
    <div id="product-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:12px;"></div>
</div>

<div id="detail" class="page">
    <div id="detail-body"></div>
</div>

<div id="cart" class="page">
    <header class="glass-header"><div class="back-btn" onclick="navigate('home')"><i class="fas fa-arrow-left"></i></div><h3>My Cart</h3></header>
    <div id="cart-list" style="padding:15px;"></div>
    <div id="checkout-form" style="padding:15px; background:white; margin:15px; border-radius:15px; display:none;">
        <h4>Shipping Information</h4>
        <input type="text" id="order-name" class="premium-input" placeholder="အမည်">
        <input type="text" id="order-phone" class="premium-input" placeholder="ဖုန်းနံပါတ်">
        <textarea id="order-addr" class="premium-input" placeholder="ပို့ဆောင်ရမည့်လိပ်စာ"></textarea>
        <button class="btn-main" onclick="confirmOrder()">Confirm Order</button>
    </div>
    <div id="cart-summary" style="padding:20px; position:fixed; bottom:70px; width:100%; background:white; box-sizing:border-box;">
        <button class="btn-main" onclick="showCheckout()">Proceed to Checkout</button>
    </div>
</div>

<div id="invoice-page" class="page">
    <header class="glass-header"><div class="back-btn" onclick="location.reload()"><i class="fas fa-times"></i></div><h3>Voucher</h3></header>
    <div style="padding:20px;">
        <div id="invoice-area">
            <h2 class="invoice-title">K.M.W JEWELRY</h2>
            <div id="invoice-info" style="font-size:13px; margin:15px 0;"></div>
            <div id="invoice-items" style="border-top:1px solid #eee; padding-top:10px;"></div>
            <div id="invoice-total" style="text-align:right; font-weight:bold; color:red; margin-top:15px; font-size:1.2rem;"></div>
        </div>
        <button class="btn-main" style="margin-top:20px; background:#28a745;" onclick="downloadVoucher()">Download Voucher Image</button>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="navigate('home', this)"><i class="fas fa-home"></i>Home</div>
    <div class="nav-item" onclick="navigate('cart', this)"><i class="fas fa-shopping-bag"></i>Cart</div>
    <div class="nav-item" onclick="alert('Order History Coming Soon')"><i class="fas fa-history"></i>History</div>
    <div class="nav-item" onclick="alert('Favorite List Coming Soon')"><i class="fas fa-heart"></i>Fav</div>
</div>

<div id="toast"></div>

<script>
    const SB_URL = "https://ltusknkpwbyriikeyday.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0dXNrbmtwd2J5cmlpa2V5ZGF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMTYxNDksImV4cCI6MjA4MTc5MjE0OX0.7TXAvr2tHl03m_gYZNYq8xyy0yYHTx0sYMN4tS6GDnA";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let products = [], cart = [], selectedQty = 1;

    // Navigation
    function navigate(pId, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pId).classList.add('active');
        if(el) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }
    }

    // Audio System
    function playSfx(type) {
        const sounds = {
            click: 'https://www.soundjay.com/buttons/button-16.mp3',
            cart: 'https://www.myinstants.com/media/sounds/cart.mp3'
        };
        new Audio(sounds[type]).play().catch(() => {});
    }

    async function loadApp() {
        const { data } = await _supabase.from('menu_items').select('*');
        products = data || [];
        document.getElementById('product-grid').innerHTML = products.map(p => `
            <div style="background:white; border-radius:15px; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,0.05);" onclick="showDetail(${p.id})">
                <img src="${p.image_url}" style="width:100%; aspect-ratio:1/1; object-fit:cover;">
                <div style="padding:10px;">
                    <div style="font-size:14px; height:38px; overflow:hidden;">${p.name}</div>
                    <div style="color:red; font-weight:bold; margin-top:5px;">${p.price.toLocaleString()} K</div>
                </div>
            </div>
        `).join('');
    }

    function showDetail(id) {
        const p = products.find(x => x.id === id);
        selectedQty = 1;
        document.getElementById('detail-body').innerHTML = `
            <header class="glass-header"><div class="back-btn" onclick="navigate('home')"><i class="fas fa-arrow-left"></i></div><h3>Product Details</h3></header>
            <img src="${p.image_url}" class="detail-img">
            <div style="padding:20px; background:white; border-radius:30px 30px 0 0; margin-top:-30px; position:relative;">
                <h2 style="color:red; margin:0;">${p.price.toLocaleString()} K</h2>
                <h3 style="margin:10px 0;">${p.name}</h3>
                <div class="qty-container">
                    <b>အရေအတွက်:</b>
                    <div style="display:flex; align-items:center; gap:15px;">
                        <button class="qty-btn" onclick="updateQty(-1)">-</button>
                        <b id="qty-val" style="font-size:1.2rem;">1</b>
                        <button class="qty-btn" onclick="updateQty(1)">+</button>
                    </div>
                </div>
                <button class="btn-main" onclick="addToCart(${p.id})">Add to Bag</button>
            </div>
        `;
        navigate('detail');
    }

    function updateQty(n) {
        selectedQty += n;
        if(selectedQty < 1) selectedQty = 1;
        document.getElementById('qty-val').innerText = selectedQty;
        playSfx('click');
    }

    function addToCart(id) {
        const p = products.find(x => x.id === id);
        cart.push({...p, buyQty: selectedQty});
        playSfx('cart');
        alert("Added to cart!");
        navigate('home');
    }

    function showCheckout() {
        if(cart.length === 0) return alert("Empty Cart");
        document.getElementById('cart-summary').style.display = 'none';
        document.getElementById('checkout-form').style.display = 'block';
    }

    async function confirmOrder() {
        const name = document.getElementById('order-name').value;
        const phone = document.getElementById('order-phone').value;
        const addr = document.getElementById('order-addr').value;
        const total = cart.reduce((s,i) => s + (i.price * i.buyQty), 0);

        if(!name || !phone) return alert("Fill Info");

        const { data, error } = await _supabase.from('orders').insert({
            customer_name: name, phone, address: addr, items: cart, total_price: total
        }).select();

        if(!error) {
            showInvoice(name, phone, addr, total, data[0].id);
        }
    }

    function showInvoice(name, phone, addr, total, id) {
        document.getElementById('invoice-info').innerHTML = `
            <b>Order ID:</b> #${id}<br>
            <b>Customer:</b> ${name}<br>
            <b>Phone:</b> ${phone}<br>
            <b>Date:</b> ${new Date().toLocaleString()}
        `;
        document.getElementById('invoice-items').innerHTML = cart.map(i => `
            <div style="display:flex; justify-content:space-between; margin:5px 0;">
                <span>${i.name} x ${i.buyQty}</span>
                <b>${(i.price * i.buyQty).toLocaleString()} K</b>
            </div>
        `).join('');
        document.getElementById('invoice-total').innerText = "Total: " + total.toLocaleString() + " K";
        navigate('invoice-page');
    }

    function downloadVoucher() {
        html2canvas(document.querySelector("#invoice-area")).then(canvas => {
            const a = document.createElement('a');
            a.download = 'KMW-Voucher.png';
            a.href = canvas.toDataURL();
            a.click();
        });
    }

    loadApp();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="my">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>K.M.W Wholesale Store</title>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<!-- html2canvas for voucher download -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root { --primary:#FF4747; --bg:#f5f7fb; --white:#fff; --accent:#28a745; }
body { margin:0; font-family:'Segoe UI',sans-serif; background:var(--bg); }
.page { display:none; padding-bottom:80px; }
.page.active { display:block; animation:fadeIn 0.3s; }
@keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

header { background:var(--primary); color:white; padding:12px 15px; display:flex; align-items:center; position:sticky; top:0; z-index:1000; }
.search-bar { flex:1; background:white; border-radius:20px; display:flex; align-items:center; padding:5px 15px; margin:0 10px; }
.search-bar input { border:none; outline:none; width:100%; }
.back-btn { width:35px; height:35px; background:rgba(255,255,255,0.2); border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; border:none; color:white; margin-right:10px; }

.products { display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:10px; }
.p-card { background:white; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.05); cursor:pointer; position:relative; }
.p-card img { width:100%; aspect-ratio:1/1; object-fit:cover; }
.p-info { padding:10px; }
.p-price { color:var(--primary); font-weight:bold; font-size:1.1rem; }

.detail-img { width:100%; aspect-ratio:1/1; object-fit:cover; }
.detail-content { padding:20px; background:white; border-radius:25px 25px 0 0; margin-top:-20px; position:relative; }

.qty-box { display:flex; align-items:center; gap:15px; margin:15px 0; padding:10px; background:#f9f9f9; border-radius:10px; width:fit-content; }
.qty-btn { width:30px; height:30px; border:1px solid #ddd; background:white; border-radius:5px; cursor:pointer; }

#voucher-print { background:white; padding:25px; border:1px solid #eee; width:100%; box-sizing:border-box; }
.voucher-header { text-align:center; border-bottom:2px dashed #ddd; padding-bottom:15px; margin-bottom:15px; }

.bottom-nav { position:fixed; bottom:0; width:100%; background:white; display:flex; justify-content:space-around; padding:10px 0; border-top:1px solid #eee; z-index:2000; }
.nav-item { text-align:center; color:#888; font-size:11px; cursor:pointer; transition:0.3s; }
.nav-item.active { color:var(--primary); }
.nav-item i { font-size:20px; display:block; margin-bottom:2px; }

#cart-modal { display:none; position:fixed; z-index:3000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
.cart-modal-content { background:#f8f9fa; border-radius:20px 20px 0 0; max-width:500px; margin:50px auto 0 auto; height:90vh; display:flex; flex-direction:column; position:relative; animation:slideUp 0.4s ease-out; }
@keyframes slideUp { from{transform:translateY(100%);} to{transform:translateY(0);} }
.cart-header { padding:15px 20px; background:white; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; border-radius:20px 20px 0 0; }
.cart-body { flex:1; overflow-y:auto; padding:15px; }
.cart-item-card { background:white; border-radius:15px; padding:12px; margin-bottom:12px; display:flex; align-items:center; gap:12px; box-shadow:0 4px 10px rgba(0,0,0,0.03); }
.cart-item-img { width:90px; height:90px; object-fit:cover; border-radius:10px; }
.qty-control { display:flex; align-items:center; gap:12px; margin-top:10px; }
.qty-btn { width:32px; height:32px; border:1px solid #eee; background:#fdfdfd; border-radius:8px; cursor:pointer; font-weight:bold; }
.checkout-bar { background:white; padding:15px 25px; display:flex; justify-content:space-between; align-items:center; border-top:1px solid #eee; padding-bottom:30px; }
.btn-checkout { background:var(--primary); color:white; border:none; padding:12px 35px; border-radius:25px; font-weight:bold; cursor:pointer; box-shadow:0 5px 15px rgba(255,71,71,0.3); }
.order-input { width:100%; padding:12px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box; outline:none; }
.btn-main { width:100%; background:var(--primary); color:white; border:none; padding:15px; border-radius:25px; font-weight:bold; cursor:pointer; }

#toast { visibility:hidden; min-width:250px; background-color:#333; color:#fff; text-align:center; border-radius:50px; padding:16px; position:fixed; z-index:5000; left:50%; bottom:100px; transform:translateX(-50%); box-shadow:0 4px 15px rgba(0,0,0,0.2); display:flex; align-items:center; justify-content:center; gap:10px; font-weight:bold; }
#toast.show { visibility:visible; animation:fadein 0.5s, fadeout 0.5s 2.5s; }
@keyframes fadein { from{bottom:0; opacity:0;} to{bottom:100px; opacity:1;} }
@keyframes fadeout { from{bottom:100px; opacity:1;} to{bottom:0; opacity:0;} }
</style>
</head>

<body>
<div id="toast"><i class="fas fa-check-circle" style="color:#4CAF50;"></i> ခြင်းထဲသို့ ထည့်ပြီးပါပြီ</div>

<!-- Home / Product List -->
<div id="home" class="page active">
  <header>
    <div style="font-weight:bold;">KMW</div>
    <div class="search-bar"><input type="text" id="search-input" placeholder="ပစ္စည်းရှာရန်..."></div>
    <i class="fas fa-shopping-cart" onclick="navigate('cart')"></i>
  </header>
  <div class="products" id="product-list"></div>
</div>

<!-- Product Detail -->
<div id="detail" class="page">
  <header>
    <button class="back-btn" onclick="navigate('home')"><i class="fas fa-arrow-left"></i></button>
    <span>Product Details</span>
  </header>
  <div id="detail-data"></div>
</div>

<!-- Cart / Checkout -->
<div id="cart" class="page">
  <header>
    <button class="back-btn" onclick="navigate('home')"><i class="fas fa-arrow-left"></i></button>
    <span>Checkout</span>
  </header>
  <div id="cart-items-list" style="padding:10px;"></div>
  <div id="checkout-area" style="padding:15px; background:white; margin:10px; border-radius:12px;">
    <h4 style="margin:0 0 10px 0;">Order Information</h4>
    <input type="text" id="cust-name" class="order-input" placeholder="ဝယ်သူအမည်">
    <input type="text" id="cust-phone" class="order-input" placeholder="ဖုန်းနံပါတ်">
    <textarea id="cust-addr" class="order-input" placeholder="ပို့ဆောင်ရမည့်လိပ်စာ"></textarea>
    <div style="display:flex; justify-content:space-between; margin:10px 0; font-weight:bold;">
      <span>Total:</span> <span id="total-price" style="color:red;">0 K</span>
    </div>
    <button class="btn-main" onclick="confirmOrder()">Confirm Order</button>
  </div>
</div>

<!-- Voucher / Invoice -->
<div id="voucher-page" class="page">
  <header><button class="back-btn" onclick="navigate('home')"><i class="fas fa-times"></i></button><span>Invoice</span></header>
  <div style="padding:20px;">
    <div id="voucher-print">
      <div class="voucher-header">
        <h2 style="margin:0; color:var(--primary);">K.M.W JEWELRY</h2>
        <small>Wholesale & Retail Service</small>
      </div>
      <div id="voucher-details" style="font-size:13px; line-height:1.6;"></div>
      <hr style="border:0.5px solid #eee; margin:15px 0;">
      <div id="voucher-items-list"></div>
      <div id="voucher-total-area" style="text-align:right; font-weight:bold; font-size:1.2rem; color:red; margin-top:15px;"></div>
    </div>
    <button class="btn-main" style="margin-top:20px; background:var(--accent);" onclick="downloadVoucher()">Download Image</button>
  </div>
</div>

<!-- Bottom Navigation -->
<div class="bottom-nav">
  <div class="nav-item active" id="btn-home" onclick="navigate('home')"><i class="fas fa-home"></i>Home</div>
  <div class="nav-item" id="btn-cat" onclick="alert('Category Coming Soon')"><i class="fas fa-list"></i>Category</div>
  <div class="nav-item" id="btn-cart" onclick="navigate('cart')"><i class="fas fa-shopping-bag"></i>Cart</div>
  <div class="nav-item" id="btn-hist" onclick="loadHistory()"><i class="fas fa-history"></i>History</div>
</div>

<script>
const SB_URL = "https://ltusknkpwbyriikeyday.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0dXNrbmtwd2J5cmlpa2V5ZGF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMTYxNDksImV4cCI6MjA4MTc5MjE0OX0.7TXAvr2tHl03m_gYZNYq8xyy0yYHTx0sYMN4tS6GDnA";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

// ================== Navigation ==================
function navigate(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id)?.classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  if(id==='home') document.getElementById('btn-home').classList.add('active');
  if(id==='cart') document.getElementById('btn-cart').classList.add('active');
}

// ================== Toast ==================
function showToast(){
  const t=document.getElementById("toast");
  t.className="show";
  setTimeout(()=>{ t.className=t.className.replace("show",""); },3000);
}

// ================== Load Items ==================
async function loadItems(){
  const { data,error } = await _supabase.from("items")
    .select("*, item_variants(*), wholesale_prices(*)")
    .eq("active",true);
  if(error){ alert(error.message); return; }
  productsData = data;
  renderItems(data);
}

// ================== Render Items ==================
function renderItems(items){
  const box=document.getElementById("product-list");
  box.innerHTML="";
  items.forEach(item=>{
    const div=document.createElement("div");
    div.className="p-card";
    div.innerHTML=`<img src="${item.image_url || ''}">
      <div class="p-info">
        <div style="font-size:14px;height:35px;overflow:hidden;">${item.name}</div>
        <div class="p-price">${item.base_price.toLocaleString()} K</div>
      </div>`;
    div.onclick=()=>openDetail(item.id);
    box.appendChild(div);
  });
}

// ================== Search ==================
document.getElementById('search-input')?.addEventListener('input', e=>{
  const query = e.target.value.toLowerCase();
  renderItems(productsData.filter(p=>p.name.toLowerCase().includes(query)));
});

// ================== Detail Page ==================
async function openDetail(id){
  const { data,error } = await _supabase.from("items")
    .select("*, item_variants(*), wholesale_prices(*)")
    .eq("id",id)
    .single();
  if(error){ alert(error.message); return; }
  currentItem=data; variants=data.item_variants||[]; wholesalePrices=data.wholesale_prices||[];

  const html=`<img src="${data.image_url}" class="detail-img">
    <div class="detail-content">
      <h2 style="color:red;margin:0;">${data.base_price} K</h2>
      <h3>${data.name}</h3>
      <div class="qty-box">
        <button class="qty-btn" onclick="changeQty(-1)">-</button>
        <input type="number" id="qtyInput" value="1" min="1" style="width:50px;text-align:center;">
        <button class="qty-btn" onclick="changeQty(1)">+</button>
      </div>
      <button class="btn-main" onclick="addToCart(${data.id})">Add to Cart</button>
    </div>`;
  document.getElementById('detail-data').innerHTML=html;
  navigate('detail');
}

// ================== Wholesale Price Calculation ==================
function getWholesalePrice(qty, prices, basePrice) {
  let price = basePrice;
  if (prices && prices.length > 0) {
    // အရေအတွက်နဲ့ ကိုက်ညီတဲ့ အသက်သာဆုံး လက်ကားဈေးကို ရှာခြင်း
    prices.sort((a, b) => a.min_qty - b.min_qty).forEach(p => {
      if (qty >= p.min_qty) price = p.price_per_unit;
    });
  }
  return price;
}

// Detail Page မှာ Quantity ပြောင်းရင် ဈေးနှုန်းချက်ချင်းလိုက်ပြောင်းရန်
function changeQty(n) {
  const i = document.getElementById("qtyInput");
  i.value = Math.max(1, parseInt(i.value || 1) + n);
  
  // လက်ရှိ item ရဲ့ wholesale price ကို တွက်ချက်ပြီး ပြန်ပြပေးခြင်း
  const qty = parseInt(i.value);
  const currentPrice = getWholesalePrice(qty, wholesalePrices, currentItem.base_price);
  document.querySelector('#detail-data h2').innerText = `${currentPrice.toLocaleString()} K (x${qty})`;
}

// ================== Add to Cart (Wholesale Aware) ==================
function addToCart(id) {
  const item = productsData.find(x => x.id === id);
  const qty = parseInt(document.getElementById("qtyInput")?.value || 1);
  
  // ခြင်းထဲထည့်တဲ့အချိန်မှာ ဝယ်ယူတဲ့ အရေအတွက်အပေါ်မူတည်ပြီး ဈေးနှုန်းသတ်မှတ်ခြင်း
  const finalPrice = getWholesalePrice(qty, item.wholesale_prices, item.base_price);

  cart.push({
    id: item.id,
    name: item.name,
    image_url: item.image_url,
    buyQty: qty,
    price: finalPrice
  });

  showToast();
  navigate('home');
}

// ================== Checkout List Logic ==================
function renderCheckoutList() {
  let total = 0;
  const list = document.getElementById('cart-items-list');
  if (cart.length === 0) {
    list.innerHTML = '<p style="text-align:center; padding:20px;">ခြင်းထဲမှာ ပစ္စည်းမရှိသေးပါ။</p>';
    document.getElementById('total-price').innerText = "0 K";
    return;
  }

  list.innerHTML = cart.map(item => {
    total += (item.price * item.buyQty);
    return `<div style="display:flex;gap:10px;background:white;padding:10px;border-radius:10px;margin-bottom:10px;align-items:center;">
      <img src="${item.image_url}" style="width:50px;height:50px;border-radius:5px;object-fit:cover;">
      <div style="flex:1;"><b>${item.name}</b><br><small>${item.price.toLocaleString()} x ${item.buyQty}</small></div>
      <div style="font-weight:bold; color:red;">${(item.price * item.buyQty).toLocaleString()} K</div>
    </div>`;
  }).join('');
  document.getElementById('total-price').innerText = total.toLocaleString() + " K";
}

// ================== Confirm Order (Database Insert) ==================
async function confirmOrder() {
  const name = document.getElementById('cust-name').value.trim();
  const phone = document.getElementById('cust-phone').value.trim();
  const addr = document.getElementById('cust-addr').value.trim();

  if (!name || !phone || !addr) { alert('ကျေးဇူးပြုပြီး အချက်အလက်များ ဖြည့်ပါ'); return; }
  if (cart.length === 0) { alert('ခြင်းထဲမှာ ပစ္စည်းမရှိသေးပါ'); return; }

  const total = cart.reduce((a, b) => a + (b.price * b.buyQty), 0);
  const btn = document.querySelector('#checkout-area .btn-main');
  btn.innerText = "ခေတ္တစောင့်ပါ...";
  btn.disabled = true;

  try {
    const { data, error } = await _supabase.from("orders").insert([{
      customer_name: name,
      customer_phone: phone,
      customer_address: addr,
      items: JSON.stringify(cart),
      total: total,
      created_at: new Date().toISOString()
    }]).select();

    if (error) throw error;

    // Local History ထဲ သိမ်းခြင်း
    const history = JSON.parse(localStorage.getItem('order_history') || '[]');
    history.push({ id: data[0].id, name, phone, addr, items: [...cart], total, date: new Date().toLocaleString() });
    localStorage.setItem('order_history', JSON.stringify(history));

    renderVoucher(name, phone, addr, [...cart], data[0].id);
    cart = []; // ခြင်းကို ရှင်းပစ်ခြင်း
    navigate('voucher-page');

  } catch (err) {
    alert("မှာယူမှု မအောင်မြင်ပါ: " + err.message);
  } finally {
    btn.innerText = "Confirm Order";
    btn.disabled = false;
  }
}

// ================== Voucher Rendering ==================
function renderVoucher(name, phone, addr, items, orderId) {
  let html = '';
  items.forEach(item => {
    html += `<div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:5px; border-bottom:1px solid #eee; padding-bottom:5px;">
      <span>${item.name} (x${item.buyQty})</span>
      <b>${(item.price * item.buyQty).toLocaleString()} K</b>
    </div>`;
  });

  document.getElementById('voucher-details').innerHTML = `
    <div style="font-size:12px; margin-bottom:10px;">
      <b>Order ID:</b> #${orderId}<br>
      <b>Customer:</b> ${name}<br>
      <b>Phone:</b> ${phone}<br>
      <b>Address:</b> ${addr}<br>
      <b>Date:</b> ${new Date().toLocaleString()}
    </div>
  `;
  document.getElementById('voucher-items-list').innerHTML = html;
  document.getElementById('voucher-total-area').innerText = "Total: " + items.reduce((a, b) => a + (b.price * b.buyQty), 0).toLocaleString() + " K";
}

// ================== History Viewer ==================
function loadHistory() {
  const history = JSON.parse(localStorage.getItem('order_history') || '[]');
  if (history.length === 0) { alert('History မရှိသေးပါ'); return; }
  
  let html = history.reverse().map(h => `
    <div style="padding:15px; margin-bottom:10px; background:white; border-radius:12px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
      <div style="color:#888; font-size:11px;">${h.date}</div>
      <div style="font-weight:bold; margin-top:5px;">Order ID: #${h.id}</div>
      <div style="font-size:13px;">${h.name} (${h.phone})</div>
      <div style="color:red; font-weight:bold; margin-top:5px; text-align:right;">${h.total.toLocaleString()} K</div>
    </div>
  `).join('');

  // History ကို Window အသစ်ဖြင့် ပြသခြင်း
  const win = window.open('', 'History', 'width=400,height=600');
  win.document.write(`
    <body style="font-family:sans-serif; background:#f5f7fb; padding:20px;">
      <h3 style="text-align:center;">Order History</h3>
      ${html}
    </body>
  `);
}

// Initialize application
loadItems();
</script>
  </body>
</html>



<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ— á€™á€¼á€„á€ºá€á€¬á€€á€¼á€€á€ºá€€á€„á€º POS - Professional Version</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pyidaungsu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --amazon-orange: #ff9900; --amazon-dark: #232f3e; --bg: #f3f3f3; --price-red: #B12704; }
        body { font-family: 'Pyidaungsu', sans-serif; background: var(--bg); margin: 0; padding: 0; color: #111; }
        .container { max-width: 500px; margin: auto; background: white; min-height: 100vh; position: relative; }
        
        /* Header & Nav */
        header { background: var(--amazon-dark); color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 20px; }
        .nav-tabs { display: flex; background: #37475a; position: sticky; top: 0; z-index: 100; }
        .nav-tabs button { flex: 1; padding: 12px; border: none; background: none; color: #ccc; cursor: pointer; font-family: 'Pyidaungsu'; }
        .nav-tabs button.active { color: white; border-bottom: 4px solid var(--amazon-orange); font-weight: bold; }

        .content { padding: 15px; padding-bottom: 150px; }
        .hidden { display: none !important; }
        .card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 12px; }

        /* Shop Items */
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .price { color: var(--price-red); font-weight: bold; }
        .qty-box { display: flex; align-items: center; gap: 10px; }
        .btn-qty { width: 32px; height: 32px; border: 1px solid #bbb; background: #e7e9ec; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* Voucher Style */
        .voucher-area { border: 2px dashed #ddd; padding: 20px; background: #fff; margin-bottom: 15px; }
        .status-badge { padding: 4px 10px; border-radius: 5px; font-size: 12px; float: right; font-weight: bold; }
        .pending { background: #fff3cd; color: #856404; }
        .confirmed { background: #d4edda; color: #155724; }

        /* Payment Box */
        .pay-box { background: #fff9f0; border: 1px solid #ffcc66; padding: 15px; border-radius: 8px; text-align: center; margin: 15px 0; }
        .pay-number { font-size: 22px; color: var(--price-red); font-weight: bold; display: block; margin: 5px 0; letter-spacing: 1px; }

        /* Buttons */
        .btn-main { background: #ffd814; border: 1px solid #fcd200; border-radius: 20px; width: 100%; padding: 14px; font-weight: bold; cursor: pointer; font-size: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-download { background: #f0f2f2; border: 1px solid #d5d9d9; border-radius: 20px; width: 100%; padding: 10px; margin-top: 10px; cursor: pointer; }
        
        .footer-cart { position: fixed; bottom: 0; max-width: 500px; width: 100%; background: white; border-top: 1px solid #ddd; padding: 15px; box-sizing: border-box; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #bbb; border-radius: 4px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="container">
    <header>MYINTHAR BBQ POS</header>

    <div class="nav-tabs">
        <button id="t-shop" class="active" onclick="showTab('shop')">á€á€šá€ºá€šá€°á€›á€”á€º</button>
        <button id="t-orders" onclick="showTab('orders')">á€¡á€±á€¬á€ºá€’á€«á€…á€…á€ºá€›á€”á€º</button>
        <button id="t-admin" onclick="showTab('admin')">ADMIN</button>
    </div>

    <div id="sec-shop" class="content">
        <div class="card">
            <input type="text" id="c_name" placeholder="ğŸ‘¤ á€á€šá€ºá€šá€°á€á€°á€¡á€™á€Šá€º">
            <input type="tel" id="c_phone" placeholder="ğŸ“ á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€º">
        </div>
        <div id="menu-list"></div>
    </div>

    <div id="sec-checkout" class="content hidden">
        <div id="voucher-capture" class="voucher-area">
            <h3 style="text-align:center; color:var(--amazon-orange); margin-top:0;">á€¡á€±á€¬á€ºá€’á€«á€˜á€±á€¬á€€á€ºá€á€»á€¬</h3>
            <div id="voucher-details" style="font-size:14px; line-height:1.6;"></div>
            <div class="pay-box">
                <small>KPay / AYA Pay</small>
                <span class="pay-number">09767287345</span>
                <small>(U Ye Win)</small>
            </div>
        </div>
        <p style="font-size:13px; color:#555;">áá‹ á€¡á€•á€±á€«á€ºá€€á€”á€¶á€•á€«á€á€ºá€á€­á€¯á€· á€„á€½á€±á€œá€½á€¾á€²á€•á€¼á€®á€¸ á€–á€¼á€á€ºá€•á€­á€¯á€„á€ºá€¸á€á€„á€ºá€•á€«á‹</p>
        <input type="file" id="p_file" accept="image/*">
        <input type="text" id="p_txid" placeholder="Transaction ID (á€”á€±á€¬á€€á€ºá€†á€¯á€¶á€¸ á† á€œá€¯á€¶á€¸)">
        <button class="btn-main" onclick="submitOrder()">á€¡á€±á€¬á€ºá€’á€«á€á€„á€ºá€™á€Šá€º</button>
        <button class="btn-download" onclick="downloadVoucher()">â¬‡ï¸ Voucher á€€á€­á€¯ á€•á€¯á€¶á€¡á€–á€¼á€…á€ºá€á€­á€™á€ºá€¸á€™á€Šá€º</button>
        <button onclick="showTab('shop')" style="width:100%; background:none; border:none; margin-top:15px; color:blue;">á€•á€¼á€”á€ºá€‘á€½á€€á€ºá€™á€Šá€º</button>
    </div>

    <div id="sec-orders" class="content hidden">
        <input type="tel" id="track-phone" placeholder="á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€ºá€›á€­á€¯á€€á€ºá á€¡á€±á€¬á€ºá€’á€«á€•á€¼á€”á€ºá€›á€¾á€¬á€•á€«" oninput="fetchHistory()">
        <div id="history-display"></div>
    </div>

    <div id="sec-admin" class="content hidden">
        <div id="admin-auth">
            <input type="password" id="admin-pass" placeholder="Admin Password">
            <button class="btn-main" onclick="loginAdmin()">Login</button>
        </div>
        <div id="admin-dashboard" class="hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <div class="card" style="flex:1; text-align:center; margin-right:5px; background:var(--amazon-dark); color:white;">
                    <small>á€›á€±á€¬á€„á€ºá€¸á€›á€„á€½á€±</small><br><b id="sales-sum" style="color:var(--amazon-orange)">0</b> K
                </div>
                <div class="card" style="flex:1; text-align:center;">
                    <small>á€¡á€±á€¬á€ºá€’á€«á€•á€±á€«á€„á€ºá€¸</small><br><b id="sales-count">0</b>
                </div>
            </div>
            <h4>á€¡á€±á€¬á€ºá€’á€«á€…á€¬á€›á€„á€ºá€¸á€¡á€á€±á€¸á€…á€­á€á€º</h4>
            <div id="admin-order-list"></div>
        </div>
    </div>

    <div id="footer-cart" class="footer-cart">
        <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
            <span style="font-weight:bold;">á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸:</span>
            <span class="price" id="total-val" style="font-size:18px;">0 MMK</span>
        </div>
        <button class="btn-main" onclick="goToCheckout()">á€¡á€±á€¬á€ºá€’á€«á€á€„á€ºá€›á€”á€º á€†á€€á€ºá€á€½á€¬á€¸á€™á€Šá€º</button>
    </div>
</div>

<script>
    const SB_URL = "https://ltusknkpwbyriikeyday.supabase.co";
    const SB_KEY = "sb_publishable_u9Y8SIpzqsT4WkyONV4J2w__Xwc09Fv";
    const _supabase = window.supabase.createClient(SB_URL, SB_KEY);
    const TG_TOKEN = "8215695761:AAF1qDjAJn7gjiHyzf8t7W6c8e51cim98sU";
    const TG_CHAT_ID = "8116152317";

    const menu = [
        {name:'á€€á€¼á€€á€ºá€•á€±á€«á€„á€º', price:4000}, {name:'á€€á€¼á€€á€ºá€›á€„á€ºá€¡á€¯á€¶', price:4000}, {name:'á€†á€­á€á€ºá€á€¬á€¸á€€á€„á€º', price:1500},
        {name:'á€¡á€á€¬á€¸á€á€»á€±á€¬á€„á€ºá€¸', price:800}, {name:'á€¡á€›á€±á€á€½á€¶', price:500}, {name:'á€¡á€á€±á€¬á€„á€ºá€•á€»á€¶', price:500},
        {name:'á€¡á€á€±á€¬á€„á€ºá€•á€»á€¶(CP)', price:1000}, {name:'á€¡á€°', price:500}, {name:'á€á€±á€«á€„á€ºá€¸', price:300},
        {name:'á€œá€Šá€ºá€á€»á€±á€¬á€„á€ºá€¸', price:300}, {name:'á€¡á€á€Šá€ºá€¸á€™á€¼á€…á€º', price:500}, {name:'á€á€¼á€±á€‘á€±á€¬á€€á€º', price:300},
        {name:'á€á€¼á€±á€‘á€±á€¬á€€á€º(CP)', price:700}, {name:'á€œá€€á€ºá€™á€±á€¬á€„á€ºá€¸á€œá€¯á€¶á€¸', price:1000}, {name:'á€¡á€†á€®á€•á€°á€¸', price:800},
        {name:'á€¡á€á€¬á€¸á€á€¯', price:400}, {name:'á€›á€¯á€¶á€¸á€•á€á€±á€á€®á€¸', price:300}, {name:'á€¡á€•á€ºá€™á€¾á€­á€¯', price:1000}, {name:'á€„á€¯á€¶á€¸á€¥', price:1000}
    ];

    let cart = {};

    function showTab(t) {
        document.querySelectorAll('.content').forEach(c => c.classList.add('hidden'));
        document.querySelectorAll('.nav-tabs button').forEach(b => b.classList.remove('active'));
        document.getElementById('sec-'+t).classList.remove('hidden');
        document.getElementById('t-'+t).classList.add('active');
        document.getElementById('footer-cart').classList.toggle('hidden', t !== 'shop');
    }

    function renderShop() {
        document.getElementById('menu-list').innerHTML = menu.map(i => `
            <div class="item-row">
                <div><b>${i.name}</b><br><span class="price">${i.price} K</span></div>
                <div class="qty-box">
                    <button class="btn-qty" onclick="updateQty('${i.name}', -1)">-</button>
                    <b id="q-${i.name}">0</b>
                    <button class="btn-qty" onclick="updateQty('${i.name}', 1)">+</button>
                </div>
            </div>
        `).join('');
    }

    function updateQty(n, c) {
        cart[n] = (cart[n] || 0) + c;
        if(cart[n] < 0) cart[n] = 0;
        document.getElementById('q-'+n).innerText = cart[n];
        let total = 0;
        for(let k in cart) total += (cart[k] * menu.find(m => m.name === k).price);
        document.getElementById('total-val').innerText = total.toLocaleString() + " MMK";
    }

    function goToCheckout() {
        const name = document.getElementById('c_name').value;
        const total = document.getElementById('total-val').innerText;
        if(!name || total === "0 MMK") return alert("á€¡á€™á€Šá€ºá€”á€¾á€„á€·á€º á€•á€…á€¹á€…á€Šá€ºá€¸á€™á€»á€¬á€¸ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€±á€¸á€•á€«á‹");

        let itemsHtml = "<ul>";
        for(let k in cart) if(cart[k] > 0) itemsHtml += `<li>${k} x ${cart[k]}</li>`;
        itemsHtml += "</ul>";

        document.getElementById('voucher-details').innerHTML = `
            <p><b>á€á€šá€ºá€á€°á€¡á€™á€Šá€º:</b> ${name}</p>
            <p><b>á€™á€¾á€¬á€šá€°á€á€Šá€·á€ºá€…á€¬á€›á€„á€ºá€¸:</b></p>${itemsHtml}
            <p style="font-size:16px; border-top:1px solid #eee; padding-top:10px;"><b>á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸:</b> <span class="price">${total}</span></p>
        `;
        showTab('checkout');
        document.getElementById('footer-cart').classList.add('hidden');
    }

    async function submitOrder() {
        const btn = document.querySelector('.btn-main');
        btn.disabled = true; btn.innerText = "Submitting...";

        const file = document.getElementById('p_file').files[0];
        let img = "";
        if(file) {
            const fName = Date.now() + "_" + file.name;
            const { data } = await _supabase.storage.from('payment-proofs').upload(fName, file);
            if(data) img = SB_URL + "/storage/v1/object/public/payment-proofs/" + fName;
        }

        const orderData = {
            customer_name: document.getElementById('c_name').value,
            phone: document.getElementById('c_phone').value,
            items: Object.keys(cart).filter(k => cart[k] > 0).map(k => `${k}(${cart[k]})`).join(", "),
            total: parseInt(document.getElementById('total-val').innerText.replace(/,/g, '')),
            transaction_id: document.getElementById('p_txid').value,
            payment_image: img
        };

        const { data: res, error } = await _supabase.from('orders').insert([orderData]).select();

        if(!error) {
            const msg = `ğŸ”” *á€¡á€±á€¬á€ºá€’á€«á€¡á€á€…á€ºá€á€„á€ºá€á€Šá€º*%0A------------------%0AID: #${res[0].id}%0AğŸ‘¤ á€á€šá€ºá€á€°: ${orderData.customer_name}%0AğŸ“ á€–á€¯á€”á€ºá€¸: ${orderData.phone}%0AğŸ“¦ *á€™á€¾á€¬á€šá€°á€á€Šá€·á€ºá€…á€¬á€›á€„á€ºá€¸:*%0A${orderData.items}%0AğŸ’° á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸: ${orderData.total} K%0AğŸ”‘ TXID: ${orderData.transaction_id}`;
            fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage?chat_id=${TG_CHAT_ID}&text=${msg}&parse_mode=Markdown`);
            alert("á€¡á€±á€¬á€ºá€’á€«á€á€„á€ºá€á€¼á€„á€ºá€¸ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«á€á€Šá€ºá‹");
            location.reload();
        } else {
            alert("Error occurred. Please try again.");
            btn.disabled = false; btn.innerText = "á€¡á€±á€¬á€ºá€’á€«á€á€„á€ºá€™á€Šá€º";
        }
    }

    async function fetchHistory() {
        const p = document.getElementById('track-phone').value;
        if(p.length < 7) return;
        const { data } = await _supabase.from('orders').select('*').eq('phone', p).order('id', {descending:true});
        document.getElementById('history-display').innerHTML = data.map(o => `
            <div class="card">
                <span class="status-badge ${o.status === 'á€¡á€á€Šá€ºá€•á€¼á€¯á€•á€¼á€®á€¸' ? 'confirmed' : 'pending'}">${o.status}</span>
                <b>á€¡á€±á€¬á€ºá€’á€« ID: #${o.id}</b><br>
                <small style="color:#555">${o.items}</small><br>
                <b>á€…á€¯á€…á€¯á€•á€±á€«á€„á€ºá€¸: <span class="price">${o.total} K</span></b>
            </div>
        `).join('');
    }

    function downloadVoucher() {
        html2canvas(document.getElementById("voucher-capture")).then(canvas => {
            let link = document.createElement('a');
            link.download = 'Myinthar-Voucher.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    async function loginAdmin() {
        if(document.getElementById('admin-pass').value === "2012@Yewin") {
            document.getElementById('admin-auth').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.remove('hidden');
            const { data } = await _supabase.from('orders').select('*').order('id', {descending:true});
            document.getElementById('sales-sum').innerText = data.reduce((a,b)=> a+b.total, 0).toLocaleString();
            document.getElementById('sales-count').innerText = data.length;
            document.getElementById('admin-order-list').innerHTML = data.map(o => `
                <div class="card" style="font-size:13px;">
                    <div style="display:flex; justify-content:space-between;">
                        <b>#${o.id} - ${o.customer_name}</b>
                        <span>${o.status}</span>
                    </div>
                    <p style="color:var(--price-red); margin:5px 0;">${o.items}</p>
                    <b>${o.total} K</b> | á€–á€¯á€”á€ºá€¸: ${o.phone}<br>
                    TXID: ${o.transaction_id || 'N/A'}<br>
                    <div style="margin-top:8px;">
                        <button onclick="approveOrder(${o.id})" style="background:#2ecc71; color:white; border:none; padding:5px 10px; border-radius:4px;">á€¡á€á€Šá€ºá€•á€¼á€¯á€™á€Šá€º</button>
                        ${o.payment_image ? `<a href="${o.payment_image}" target="_blank" style="margin-left:10px;">á€•á€¯á€¶á€€á€¼á€Šá€·á€ºá€›á€”á€º</a>` : ''}
                    </div>
                </div>
            `).join('');
        } else { alert("á€…á€€á€¬á€¸á€á€¾á€€á€ºá€™á€¾á€¬á€¸á€šá€½á€„á€ºá€¸á€”á€±á€•á€«á€á€Šá€ºá‹"); }
    }

    async function approveOrder(id) {
        const { error } = await _supabase.from('orders').update({ status: 'á€¡á€á€Šá€ºá€•á€¼á€¯á€•á€¼á€®á€¸' }).eq('id', id);
        if(!error) { alert("á€¡á€±á€¬á€ºá€’á€«á€€á€­á€¯ á€¡á€á€Šá€ºá€•á€¼á€¯á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹"); loginAdmin(); }
    }

    renderShop();
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.M.W Jewelry - Professional Store</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { --primary: #FF4747; --bg: #f5f7fb; --white: #ffffff; }
        body { margin:0; font-family: 'Segoe UI', sans-serif; background:var(--bg); }
        
        /* Page Logic */
        .page { display: none; padding-bottom: 80px; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Header UI */
        header { background: var(--primary); color: white; padding: 12px 15px; display:flex; align-items:center; position:sticky; top:0; z-index:1000; }
        .search-bar { flex:1; background:white; border-radius:20px; display:flex; align-items:center; padding:5px 15px; margin: 0 10px; }
        .search-bar input { border:none; outline:none; width:100%; }

        /* Back Button Stylish */
        .back-btn { width: 35px; height: 35px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; color: white; margin-right: 10px; }

        /* Product Grid */
        .products { display:grid; grid-template-columns: 1fr 1fr; gap:10px; padding:10px; }
        .p-card { background:white; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.05); cursor:pointer; position: relative; }
        .p-card img { width:100%; aspect-ratio: 1/1; object-fit: cover; }
        .p-info { padding:10px; }
        .p-price { color:var(--primary); font-weight:bold; font-size:1.1rem; }

        /* Detail Page */
        .detail-img { width:100%; aspect-ratio:1/1; object-fit:cover; }
        .detail-content { padding:20px; background:white; border-radius:25px 25px 0 0; margin-top:-20px; position:relative; }
        
        /* Quantity Selector */
        .qty-box { display: flex; align-items: center; gap: 15px; margin: 15px 0; padding: 10px; background: #f9f9f9; border-radius: 10px; width: fit-content; }
        .qty-btn { width: 30px; height: 30px; border: 1px solid #ddd; background: white; border-radius: 5px; cursor: pointer; }

        /* Invoice/Voucher Area */
        #voucher-print { background: white; padding: 25px; border: 1px solid #eee; width: 100%; box-sizing: border-box; }
        .voucher-header { text-align: center; border-bottom: 2px dashed #ddd; padding-bottom: 15px; margin-bottom: 15px; }

        /* Bottom Menu */
        .bottom-nav { position:fixed; bottom:0; width:100%; background:white; display:flex; justify-content:space-around; padding:10px 0; border-top:1px solid #eee; z-index:2000; }
        .nav-item { text-align:center; color:#888; font-size:11px; cursor:pointer; transition: 0.3s; }
        .nav-item.active { color:var(--primary); }
        .nav-item i { font-size:20px; display:block; margin-bottom:2px; }

        /* Form Design */
        .order-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-main { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 25px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="home" class="page active">
    <header>
        <div style="font-weight:bold;">KMW</div>
        <div class="search-bar"><input type="text" id="search-input" placeholder="ပစ္စည်းရှာရန်..."></div>
        <i class="fas fa-shopping-cart" onclick="navigate('cart')"></i>
    </header>
    <div class="products" id="product-list"></div>
</div>

<div id="detail" class="page">
    <header><button class="back-btn" onclick="navigate('home')"><i class="fas fa-arrow-left"></i></button><span>Product Details</span></header>
    <div id="detail-data"></div>
</div>

<div id="cart" class="page">
    <header><button class="back-btn" onclick="navigate('home')"><i class="fas fa-arrow-left"></i></button><span>Shopping Bag</span></header>
    <div id="cart-items-list" style="padding:10px;"></div>
    <div id="checkout-area" style="padding:15px; background:white; margin:10px; border-radius:12px;">
        <h4 style="margin:0 0 10px 0;">Order Information</h4>
        <input type="text" id="cust-name" class="order-input" placeholder="ဝယ်သူအမည်">
        <input type="text" id="cust-phone" class="order-input" placeholder="ဖုန်းနံပါတ်">
        <textarea id="cust-addr" class="order-input" placeholder="ပို့ဆောင်ရမည့်လိပ်စာ"></textarea>
        <div style="display:flex; justify-content:space-between; margin:10px 0; font-weight:bold;">
            <span>Total:</span> <span id="total-price" style="color:red;">0 K</span>
        </div>
        <button class="btn-main" onclick="confirmOrder()">Confirm Order</button>
    </div>
</div>

<div id="voucher-page" class="page">
    <header><button class="back-btn" onclick="location.reload()"><i class="fas fa-times"></i></button><span>Invoice</span></header>
    <div style="padding:20px;">
        <div id="voucher-print">
            <div class="voucher-header">
                <h2 style="margin:0; color:var(--primary);">K.M.W JEWELRY</h2>
                <small>Wholesale & Retail Service</small>
            </div>
            <div id="voucher-details" style="font-size:13px; line-height:1.6;"></div>
            <hr style="border:0.5px solid #eee; margin:15px 0;">
            <div id="voucher-items-list"></div>
            <div id="voucher-total-area" style="text-align:right; font-weight:bold; font-size:1.1rem; color:red; margin-top:15px;"></div>
        </div>
        <button class="btn-main" style="margin-top:20px; background:#28a745;" onclick="downloadVoucher()">Download Image</button>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" id="btn-home" onclick="navigate('home')"><i class="fas fa-home"></i>Home</div>
    <div class="nav-item" id="btn-cat" onclick="alert('Categories Loaded!')"><i class="fas fa-list"></i>Category</div>
    <div class="nav-item" id="btn-cart" onclick="navigate('cart')"><i class="fas fa-shopping-bag"></i>Cart</div>
    <div class="nav-item" id="btn-hist" onclick="alert('History System Syncing...')"><i class="fas fa-history"></i>History</div>
</div>

<script>
    const SB_URL = "https://ltusknkpwbyriikeyday.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0dXNrbmtwd2J5cmlpa2V5ZGF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMTYxNDksImV4cCI6MjA4MTc5MjE0OX0.7TXAvr2tHl03m_gYZNYq8xyy0yYHTx0sYMN4tS6GDnA";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let productsData = [], cart = [], selectedQty = 1;

    // Sounds System
    function playSfx(type) {
        const audio = new Audio(type === 'pop' ? 'https://www.soundjay.com/buttons/button-16.mp3' : 'https://www.myinstants.com/media/sounds/cart.mp3');
        audio.play().catch(() => {});
    }

    // Navigation
    function navigate(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(id === 'home') document.getElementById('btn-home').classList.add('active');
        if(id === 'cart') { 
            document.getElementById('btn-cart').classList.add('active');
            renderCart();
        }
    }

    async function loadData() {
        const { data } = await _supabase.from('menu_items').select('*');
        productsData = data || [];
        document.getElementById('product-list').innerHTML = productsData.map(p => `
            <div class="p-card" onclick="showDetail(${p.id})">
                <img src="${p.image_url}">
                <div class="p-info">
                    <div style="font-size:14px; height:35px; overflow:hidden;">${p.name}</div>
                    <div class="p-price">${p.price.toLocaleString()} K</div>
                </div>
            </div>
        `).join('');
    }

    function showDetail(id) {
        const p = productsData.find(x => x.id === id);
        selectedQty = 1;
        document.getElementById('detail-data').innerHTML = `
            <img src="${p.image_url}" class="detail-img">
            <div class="detail-content">
                <h2 style="color:red; margin:0;">${p.price.toLocaleString()} K</h2>
                <h3>${p.name}</h3>
                <div class="qty-box">
                    <button class="qty-btn" onclick="updateQty(-1)">-</button>
                    <b id="qty-val">1</b>
                    <button class="qty-btn" onclick="updateQty(1)">+</button>
                </div>
                <button class="btn-main" onclick="addToCart(${p.id})">Add to Cart</button>
            </div>
        `;
        navigate('detail');
    }

    function updateQty(n) {
        selectedQty += n;
        if(selectedQty < 1) selectedQty = 1;
        document.getElementById('qty-val').innerText = selectedQty;
        playSfx('pop');
    }

    function addToCart(id) {
        const p = productsData.find(x => x.id === id);
        cart.push({...p, buyQty: selectedQty});
        playSfx('cart');
        alert("ခြင်းထဲသို့ ထည့်ပြီးပါပြီ။");
        navigate('home');
    }

    function renderCart() {
        let total = 0;
        document.getElementById('cart-items-list').innerHTML = cart.map((item, idx) => {
            total += (item.price * item.buyQty);
            return `<div style="display:flex; gap:10px; background:white; padding:10px; border-radius:10px; margin-bottom:10px;">
                <img src="${item.image_url}" style="width:50px; height:50px; border-radius:5px;">
                <div style="flex:1;"><b>${item.name}</b><br><small>${item.price} x ${item.buyQty}</small></div>
                <i class="fas fa-trash" style="color:#ddd" onclick="cart.splice(${idx},1); renderCart();"></i>
            </div>`;
        }).join('');
        document.getElementById('total-price').innerText = total.toLocaleString() + " K";
    }

    async function confirmOrder() {
        const name = document.getElementById('cust-name').value;
        const phone = document.getElementById('cust-phone').value;
        const addr = document.getElementById('cust-addr').value;
        const total = cart.reduce((s, i) => s + (i.price * i.buyQty), 0);

        if(!name || !phone) return alert("အချက်အလက်ပြည့်စုံစွာဖြည့်ပါ။");

        const { data, error } = await _supabase.from('orders').insert({
            customer_name: name, phone: phone, address: addr, items: cart, total_price: total
        }).select();

        if(!error) {
            showVoucher(name, phone, addr, total, data[0].id);
        }
    }

    function showVoucher(name, phone, addr, total, id) {
        document.getElementById('voucher-details').innerHTML = `
            <b>Order ID:</b> #${id}<br>
            <b>ဝယ်သူအမည်:</b> ${name}<br>
            <b>ဖုန်းနံပါတ်:</b> ${phone}<br>
            <b>လိပ်စာ:</b> ${addr}<br>
            <b>ရက်စွဲ:</b> ${new Date().toLocaleDateString()}
        `;
        document.getElementById('voucher-items-list').innerHTML = cart.map(i => `
            <div style="display:flex; justify-content:space-between; font-size:13px;">
                <span>${i.name} x ${i.buyQty}</span>
                <b>${(i.price * i.buyQty).toLocaleString()} K</b>
            </div>
        `).join('');
        document.getElementById('voucher-total-area').innerText = "Total: " + total.toLocaleString() + " K";
        navigate('voucher-page');
    }

    function downloadVoucher() {
        html2canvas(document.querySelector("#voucher-print")).then(canvas => {
            const link = document.createElement('a');
            link.download = 'KMW-Voucher.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    loadData();
</script>
</body>
</html>


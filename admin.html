<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.M.W Jewelry ‚Äì Admin & Shop</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --p: #FF4747; --bg: #f5f7fb; }
        body { margin: 0; font-family: 'Pyidaungsu', sans-serif; background: var(--bg); padding-bottom: 80px; }
        header { background: var(--p); color: #fff; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .login-btn { background: #fff; color: var(--p); border: none; padding: 8px 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .products { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; padding: 15px; }
        .card { background: #fff; border-radius: 12px; padding: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 10px; margin-bottom: 10px; }
        .btn { background: var(--p); color: #fff; border: none; padding: 10px; border-radius: 8px; width: 100%; cursor: pointer; margin-top: 5px; }
        .admin { display: none; padding: 15px; }
        .order { background: #fff; padding: 15px; border-left: 5px solid var(--p); margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
        .modal-box { background: #fff; width: 90%; max-width: 400px; margin: 50px auto; padding: 20px; border-radius: 15px; position: relative; }
        select { width: 100%; padding: 8px; margin-top: 10px; border-radius: 5px; border: 1px solid #ddd; }
    </style>
</head>
<body>

<header>
    <div style="font-weight: bold;">K.M.W</div>
    <div>
        <button class="login-btn" onclick="toggleAdmin()" id="adminBtn" style="display:none; margin-right: 5px;">Admin</button>
        <button class="login-btn" onclick="auth()" id="authBtn">Login</button>
    </div>
</header>

<div id="shop-view">
    <div class="products" id="products">Loading products...</div>
</div>

<div class="admin" id="adminPanel">
    <button onclick="location.reload()" style="background:none; border: 1px solid #666; padding: 5px 10px; border-radius: 5px; margin-bottom: 15px;">‚¨Ö Back to Shop</button>
    <h3>Orders Management</h3>
    <div id="orders"></div>
</div>

<div class="modal" id="cartModal">
    <div class="modal-box">
        <h3>üõí Cart</h3>
        <div id="cartItems"></div>
        <hr>
        <div style="display:flex; justify-content: space-between; font-weight: bold;">
            <span>Total:</span> <span id="total">0</span> Ks
        </div><br>
        <button class="btn" onclick="checkout()">Confirm Checkout</button>
        <button class="btn" style="background:#ccc; color:#000" onclick="closeModal()">Close</button>
    </div>
</div>

<div class="modal" id="invoiceModal">
    <div class="modal-box" style="text-align: center;">
        <div id="invoice" style="padding: 10px; background: #fff;">
            <h2 style="color:var(--p)">K.M.W Jewelry</h2>
            <p id="invId" style="font-size: 0.8rem; color: #666;"></p>
            <div id="invItems" style="text-align: left; margin: 15px 0;"></div>
            <hr>
            <h3 style="display:flex; justify-content: space-between;">Total: <span id="invTotal"></span></h3>
        </div>
        <button class="btn" onclick="downloadInvoice()">üì∏ Save as Image</button>
        <button class="btn" style="background:#ccc; color:#000" onclick="location.reload()">Done</button>
    </div>
</div>

<button onclick="openCart()" style="position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; border:none; background:var(--p); color:#fff; font-size:25px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 99; cursor: pointer;">
    üõí
</button>

<script>
// Supabase Configuration
const supa = supabase.createClient(
    "https://ltusknkpwbyriikeyday.supabase.co",
    "YOUR_PUBLIC_ANON_KEY" // <--- ·Ä§·Äî·Ä±·Äõ·Ä¨·Äê·ÄΩ·ÄÑ·Ä∫ ·Äû·ÄÑ·Ä∫·Åè Key ·Ä°·Äô·Äæ·Äî·Ä∫·ÄÄ·Ä≠·ÄØ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´
);

const ADMIN_EMAIL = "yewin5375@gmail.com";
let currentUser = null;
let cart = [];

// AUTHENTICATION
async function auth() {
    const { data: { user } } = await supa.auth.getUser();
    if (user) {
        await supa.auth.signOut();
        location.reload();
    } else {
        await supa.auth.signInWithOAuth({ provider: "google" });
    }
}

async function checkUser() {
    const { data: { user } } = await supa.auth.getUser();
    if (!user) {
        loadProducts(); // ·Äú·Ä∞·ÄÄ·Äº·ÄÆ·Ä∏·Äô·ÄÑ·Ä∫·Ä∏ Login ·Äô·Äù·ÄÑ·Ä∫·Äë·Ä¨·Ä∏·Äû·Ä±·Ä¨·Ä∫·Äú·Ää·Ä∫·Ä∏ Product ·Äï·Äº·Äô·Ää·Ä∫
        return;
    }
    currentUser = user;
    document.getElementById("authBtn").innerText = "Logout";
    if (user.email === ADMIN_EMAIL) {
        document.getElementById("adminBtn").style.display = "inline-block";
    }
    await loadCart();
    loadProducts();
}
checkUser();

// PRODUCTS
async function loadProducts() {
    const { data, error } = await supa.from("products").select("*").order("created_at", { ascending: false });
    if (error) return;
    document.getElementById("products").innerHTML = data.map(p => `
        <div class="card">
            <img src="${p.image_url}" alt="${p.name}">
            <div style="font-weight:bold; margin-bottom: 5px;">${p.name}</div>
            <div style="color:var(--p); margin-bottom: 10px;">${p.wholesale_price.toLocaleString()} Ks</div>
            <button class="btn" onclick="addCart(${p.id})">+ Add to Cart</button>
        </div>`).join("");
}

// CART ACTIONS
async function loadCart() {
    if (!currentUser) return;
    const { data } = await supa.from("cart_items").select("*, products(*)").eq("user_id", currentUser.id);
    cart = data || [];
}

async function addCart(pid) {
    if (!currentUser) return alert("·ÄÄ·Äª·Ä±·Ä∏·Äá·Ä∞·Ä∏·Äï·Äº·ÄØ·Åç ·Ä°·Äõ·ÄÑ·Ä∫ Login ·Äù·ÄÑ·Ä∫·Äï·Ä´·Åã");
    
    const existing = cart.find(i => i.product_id === pid);
    if (existing) {
        await supa.from("cart_items").update({ quantity: existing.quantity + 1 }).eq("id", existing.id);
    } else {
        await supa.from("cart_items").insert({ user_id: currentUser.id, product_id: pid, quantity: 1 });
    }
    await loadCart();
    alert("Added to cart!");
}

function openCart() {
    if (!currentUser) return alert("Login ·Ä°·Äõ·ÄÑ·Ä∫·Äù·ÄÑ·Ä∫·Äï·Ä´·Åã");
    if (cart.length === 0) return alert("Cart ·Äë·Ä≤·Äô·Äæ·Ä¨ ·Äò·Ä¨·Äô·Äæ·Äô·Äõ·Äæ·Ä≠·Äû·Ä±·Ä∏·Äï·Ä´·Åã");

    let total = 0;
    document.getElementById("cartItems").innerHTML = cart.map(i => {
        const itemTotal = i.products.wholesale_price * i.quantity;
        total += itemTotal;
        return `<div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span>${i.products.name} (x${i.quantity})</span>
                    <span>${itemTotal.toLocaleString()} Ks</span>
                </div>`;
    }).join("");
    
    document.getElementById("total").innerText = total.toLocaleString();
    document.getElementById("cartModal").style.display = "block";
}

function closeModal() { document.querySelectorAll(".modal").forEach(m => m.style.display = "none"); }

// CHECKOUT
async function checkout() {
    if (cart.length === 0) return;
    let total = 0;
    cart.forEach(i => total += i.products.wholesale_price * i.quantity);

    const { data: order, error } = await supa.from("orders").insert({
        user_id: currentUser.id,
        total_price: total,
        status: "Pending"
    }).select().single();

    if (error) return alert("Error: " + error.message);

    for (const item of cart) {
        await supa.from("order_items").insert({
            order_id: order.id,
            product_name: item.products.name,
            price: item.products.wholesale_price,
            quantity: item.quantity
        });
    }

    await supa.from("cart_items").delete().eq("user_id", currentUser.id);
    showInvoice(order.id, total);
}

function showInvoice(id, total) {
    closeModal();
    document.getElementById("invoiceModal").style.display = "block";
    document.getElementById("invId").innerText = "Order ID: #" + id.slice(0, 8);
    document.getElementById("invTotal").innerText = total.toLocaleString() + " Ks";
    document.getElementById("invItems").innerHTML = cart.map(i => 
        `<div>${i.products.name} x ${i.quantity}</div>`
    ).join("");
}

function downloadInvoice() {
    html2canvas(document.getElementById("invoice")).then(canvas => {
        const link = document.createElement("a");
        link.download = "KMW-Invoice.png";
        link.href = canvas.toDataURL();
        link.click();
    });
}

// ADMIN PANEL
function toggleAdmin() {
    document.getElementById("shop-view").style.display = "none";
    document.getElementById("adminPanel").style.display = "block";
    loadOrders();
}

async function loadOrders() {
    const { data, error } = await supa.from("orders").select("*").order("created_at", { ascending: false });
    if (error) return;
    document.getElementById("orders").innerHTML = data.map(o => `
        <div class="order">
            <b>Order ID: #${o.id.slice(0, 8)}</b><br>
            Time: ${new Date(o.created_at).toLocaleString()}<br>
            Total: <b>${o.total_price.toLocaleString()} Ks</b><br>
            <select onchange="updateStatus('${o.id}', this.value)">
                <option value="Pending" ${o.status == "Pending" ? "selected" : ""}>‚è≥ Pending</option>
                <option value="Paid" ${o.status == "Paid" ? "selected" : ""}>‚úÖ Paid</option>
                <option value="Delivered" ${o.status == "Delivered" ? "selected" : ""}>üöö Delivered</option>
                <option value="Cancelled" ${o.status == "Cancelled" ? "selected" : ""}>‚ùå Cancelled</option>
            </select>
        </div>`).join("");
}

async function updateStatus(id, s) {
    const { error } = await supa.from("orders").update({ status: s }).eq("id", id);
    if (!error) alert("Status updated to " + s);
}
</script>

</body>
</html>

